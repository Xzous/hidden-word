<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Detectives</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<script src="https://unpkg.com/peerjs@1.5.5/dist/peerjs.min.js"></script>
<style>
@import url('https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700;900&display=swap');

*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
:root{
--bg:#12080a;--bg2:#1a0e11;--card:#221418;--card2:#2c1a1f;
--gold:#c9a84c;--gold2:#dfc06a;--gold-dim:#7a6428;
--green:#5a9e6f;--red:#a83232;--blue:#6b8db5;--purple:#8b5e7a;
--maroon:#7a2030;--maroon2:#a03040;--maroon-dim:#4a1218;
--text:#ede4dc;--text2:#a89a8e;--text3:#6b5f56;
--radius:14px;--shadow:0 8px 32px rgba(0,0,0,0.55);
--font-display:'Playfair Display',Georgia,'Times New Roman',serif;
}
html,body{height:100%;font-family:'Segoe UI',system-ui,-apple-system,sans-serif;background:var(--bg);color:var(--text);overflow:hidden}
#app{height:100%;display:flex;flex-direction:column;max-width:480px;margin:0 auto;position:relative;z-index:1}

/* ===== ATMOSPHERE ===== */
#atmosphere{position:fixed;inset:0;pointer-events:none;z-index:0;overflow:hidden}
.ambient-glow{position:absolute;border-radius:50%;filter:blur(100px);opacity:0.07;animation:glowDrift 25s ease-in-out infinite alternate}
.ambient-glow.g1{width:500px;height:500px;background:var(--maroon);top:-150px;left:-150px}
.ambient-glow.g2{width:350px;height:350px;background:var(--gold);bottom:-100px;right:-150px;animation-delay:-12s}
.ambient-glow.g3{width:250px;height:250px;background:var(--maroon2);top:40%;right:-80px;animation-delay:-7s}
#vignette{position:fixed;inset:0;pointer-events:none;z-index:998;
  background:radial-gradient(ellipse at 50% 45%,transparent 40%,rgba(12,6,8,0.8) 100%)}
.particle{position:fixed;background:rgba(201,168,76,0.15);border-radius:50%;pointer-events:none;z-index:0}
#urgent-border{position:fixed;inset:0;pointer-events:none;z-index:997;border:3px solid transparent;
  transition:border-color .3s;border-radius:4px}
#urgent-border.active{animation:urgentPulse 1s ease-in-out infinite}

/* ===== SCREENS ===== */
.screen{position:absolute;inset:0;display:flex;flex-direction:column;padding:20px;overflow-y:auto;
  opacity:0;pointer-events:none;transform:translateY(12px) scale(0.99);
  transition:opacity .5s cubic-bezier(.16,1,.3,1),transform .5s cubic-bezier(.16,1,.3,1)}
.screen.active{opacity:1;pointer-events:auto;transform:translateY(0) scale(1)}

/* ===== TYPOGRAPHY ===== */
h1{font-family:var(--font-display);font-size:30px;font-weight:900;color:var(--gold);text-align:center;
  letter-spacing:var(--ls,4px);text-shadow:0 0 40px rgba(201,168,76,0.2)}
h2{font-family:var(--font-display);font-size:22px;font-weight:700;color:var(--gold2);text-align:center;
  margin-bottom:8px;letter-spacing:0.5px}
h3{font-size:16px;font-weight:600;color:var(--text2);text-align:center}
.subtitle{font-size:14px;color:var(--text2);text-align:center;margin-top:4px;line-height:1.6}

/* ===== BUTTONS ===== */
.btn{display:block;width:100%;padding:16px;border:none;border-radius:var(--radius);font-size:17px;
  font-weight:700;cursor:pointer;transition:all .2s cubic-bezier(.16,1,.3,1);text-align:center;font-family:inherit;
  position:relative;overflow:hidden}
.btn::after{content:'';position:absolute;inset:0;opacity:0;
  background:radial-gradient(circle at 50% 50%,rgba(255,255,255,0.08),transparent 70%);transition:opacity .2s}
.btn:active::after{opacity:1}
.btn-gold{background:linear-gradient(135deg,var(--maroon),var(--maroon2));color:var(--text);
  box-shadow:0 4px 24px rgba(122,32,48,0.35),inset 0 1px 0 rgba(255,255,255,0.1);
  text-shadow:0 1px 2px rgba(0,0,0,0.3)}
.btn-gold:active{transform:scale(0.97);box-shadow:0 2px 12px rgba(122,32,48,0.3)}
.btn-outline{background:transparent;border:2px solid var(--maroon-dim);color:var(--gold)}
.btn-outline:active{background:rgba(122,32,48,0.1);transform:scale(0.97)}
.btn-red{background:var(--red);color:white;box-shadow:0 4px 16px rgba(168,50,50,0.3)}
.btn-green{background:var(--green);color:white;box-shadow:0 4px 16px rgba(90,158,111,0.3)}
.btn-sm{padding:10px 16px;font-size:14px;width:auto;display:inline-block}
.btn:disabled{opacity:0.35;pointer-events:none}

/* ===== INPUT ===== */
input[type=text]{width:100%;padding:14px 16px;background:var(--card2);border:2px solid rgba(255,255,255,0.05);
  border-radius:var(--radius);color:var(--text);font-size:16px;font-family:inherit;outline:none;
  transition:border-color .3s,box-shadow .3s}
input[type=text]:focus{border-color:var(--maroon);box-shadow:0 0 20px rgba(122,32,48,0.1)}
input::placeholder{color:var(--text3)}

/* ===== CARDS ===== */
.card{background:linear-gradient(160deg,var(--card),var(--card2));border-radius:var(--radius);padding:20px;
  box-shadow:var(--shadow);border:1px solid rgba(255,255,255,0.04)}
.card-glow{border:1px solid rgba(122,32,48,0.2);
  box-shadow:var(--shadow),0 0 50px rgba(122,32,48,0.05),inset 0 0 30px rgba(122,32,48,0.02)}

/* ===== PLAYER CHIPS ===== */
.player-chip{display:inline-flex;align-items:center;gap:6px;padding:8px 14px;border-radius:30px;
  font-size:14px;font-weight:600;background:var(--card2);border:1.5px solid rgba(255,255,255,0.06);margin:4px;
  transition:all .25s;cursor:pointer}
.player-chip.selected{border-color:var(--gold);background:rgba(201,168,76,0.1);color:var(--gold);
  box-shadow:0 0 16px rgba(201,168,76,0.12)}
.player-chip .dot{width:8px;height:8px;border-radius:50%;background:var(--green);display:inline-block}

/* ===== WORD GRID ===== */
.word-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin:12px 0}
.word-cell{padding:0;border-radius:12px;background:var(--card2);border:2px solid rgba(255,255,255,0.04);
  text-align:center;font-size:15px;font-weight:600;cursor:default;transition:all .25s cubic-bezier(.16,1,.3,1);
  aspect-ratio:1;display:flex;flex-direction:column;align-items:center;justify-content:center;user-select:none;
  overflow:hidden;position:relative;box-shadow:0 4px 16px rgba(0,0,0,0.35)}
.word-cell .cell-icon{font-size:36px;line-height:1;margin-bottom:4px;filter:drop-shadow(0 2px 6px rgba(0,0,0,0.4))}
.word-cell .cell-label{font-size:10px;font-weight:700;color:var(--text);text-transform:uppercase;letter-spacing:0.5px;
  padding:0 4px;line-height:1.2;max-width:100%;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.word-cell .cell-accent{position:absolute;inset:0;border-radius:10px;opacity:0.12;pointer-events:none}
.word-cell.interactive{cursor:pointer}
.word-cell.interactive:active{transform:scale(0.94)}
.word-cell.selected{border-color:var(--gold);box-shadow:0 0 24px rgba(201,168,76,0.3),inset 0 0 20px rgba(201,168,76,0.04)}
.word-cell.correct{border-color:var(--green);box-shadow:0 0 20px rgba(90,158,111,0.3)}
.word-cell.wrong{border-color:var(--red);box-shadow:0 0 20px rgba(168,50,50,0.3)}

/* ===== TIMER ===== */
.timer-wrap{display:flex;flex-direction:column;align-items:center;margin:16px 0}
.timer-ring{position:relative;width:100px;height:100px}
.timer-ring svg{width:100%;height:100%;transform:rotate(-90deg)}
.timer-ring circle{fill:none;stroke-width:6;stroke-linecap:round}
.timer-ring .bg{stroke:var(--card2)}
.timer-ring .fg{stroke:var(--gold);transition:stroke-dashoffset .5s linear,stroke .3s;
  filter:drop-shadow(0 0 6px rgba(201,168,76,0.25))}
.timer-ring .fg.urgent{stroke:var(--red);filter:drop-shadow(0 0 10px rgba(168,50,50,0.5))}
.timer-digits{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;
  font-size:28px;font-weight:800;font-variant-numeric:tabular-nums;transition:color .3s}
.timer-label{font-size:13px;color:var(--text2);margin-top:6px;font-weight:600;letter-spacing:1px;text-transform:uppercase}

/* ===== ROLE CARD (flip) ===== */
.role-card-container{perspective:800px;margin:20px 0}
.role-card{position:relative;width:100%;min-height:240px;transition:transform .7s cubic-bezier(.4,0,.2,1);transform-style:preserve-3d}
.role-card.flipped{transform:rotateY(180deg)}
.role-card .face{position:absolute;inset:0;backface-visibility:hidden;border-radius:var(--radius);
  display:flex;flex-direction:column;align-items:center;justify-content:center;padding:24px}
.role-card .front{background:linear-gradient(135deg,var(--card),var(--card2));border:2px solid var(--maroon-dim);
  cursor:pointer;box-shadow:0 0 50px rgba(122,32,48,0.06)}
.role-card .front::after{content:var(--tap-text, 'Tap to Reveal');font-family:var(--font-display);color:var(--gold);
  font-size:16px;font-weight:700;margin-top:12px;letter-spacing:2px}
.role-card .back{transform:rotateY(180deg);border:2px solid var(--maroon);
  box-shadow:0 0 40px rgba(122,32,48,0.1)}
.role-icon{font-size:48px;margin-bottom:8px}
.role-name{font-family:var(--font-display);font-size:24px;font-weight:900;letter-spacing:1px}
.role-word{font-size:18px;color:var(--gold2);margin-top:12px;padding:8px 20px;background:rgba(201,168,76,0.06);
  border-radius:8px;border:1px dashed var(--gold-dim)}

/* ===== ROLE INFO BADGE ===== */
.role-info{padding:12px 16px;border-radius:12px;margin:8px 0;text-align:center;font-weight:600;font-size:14px}
.role-info.judge{background:rgba(201,168,76,0.08);border:1px solid rgba(201,168,76,0.2);color:var(--gold)}
.role-info.witness{background:rgba(90,158,111,0.08);border:1px solid rgba(90,158,111,0.2);color:var(--green)}
.role-info.detective{background:rgba(107,141,181,0.08);border:1px solid rgba(107,141,181,0.2);color:var(--blue)}
.role-info.suspect{background:rgba(168,50,50,0.08);border:1px solid rgba(168,50,50,0.2);color:var(--red)}
.role-info .hint-word{font-family:var(--font-display);font-size:22px;font-weight:900;display:block;
  margin-top:4px;letter-spacing:1px}

/* ===== STAGE BADGE ===== */
.stage-badge{display:inline-flex;align-items:center;gap:6px;padding:6px 14px;border-radius:20px;
  font-size:12px;font-weight:700;text-transform:uppercase;letter-spacing:var(--ls-sm,1.5px);margin:8px auto}
.stage-badge.loc{background:rgba(107,141,181,0.1);color:var(--blue);border:1px solid rgba(107,141,181,0.25)}
.stage-badge.weap{background:rgba(168,50,50,0.1);color:var(--red);border:1px solid rgba(168,50,50,0.25)}
.stage-badge.sus{background:rgba(139,94,122,0.1);color:var(--purple);border:1px solid rgba(139,94,122,0.25)}

/* ===== RESULT BANNER ===== */
.result-banner{padding:16px;border-radius:var(--radius);text-align:center;font-family:var(--font-display);
  font-size:20px;font-weight:700;margin:12px 0;animation:resultReveal .5s cubic-bezier(.16,1,.3,1);letter-spacing:1px}
.result-banner.correct{background:rgba(90,158,111,0.1);color:var(--green);border:1px solid rgba(90,158,111,0.25);
  box-shadow:0 0 30px rgba(90,158,111,0.06)}
.result-banner.wrong{background:rgba(168,50,50,0.1);color:var(--red);border:1px solid rgba(168,50,50,0.25);
  box-shadow:0 0 30px rgba(168,50,50,0.06)}

/* ===== PLAYER LIST ===== */
.player-list{display:flex;flex-wrap:wrap;justify-content:center;gap:4px;margin:8px 0}

/* ===== LOBBY ===== */
.room-code{font-size:42px;font-weight:900;letter-spacing:var(--ls-code,12px);color:var(--gold2);text-align:center;
  padding:20px;background:var(--card);border-radius:var(--radius);border:2px dashed var(--gold-dim);
  font-family:'Courier New',monospace;margin:12px 0;user-select:all;
  text-shadow:0 0 24px rgba(223,192,106,0.2);box-shadow:inset 0 0 40px rgba(201,168,76,0.02)}
.lobby-player{display:flex;align-items:center;gap:10px;padding:10px 14px;background:var(--card2);
  border-radius:10px;margin-bottom:8px;animation:slideIn .3s;border:1px solid rgba(255,255,255,0.03)}
.lobby-player .name{flex:1;font-weight:600;font-size:15px}
.lobby-player .host-tag{font-size:11px;padding:3px 8px;border-radius:10px;background:rgba(122,32,48,0.2);
  color:var(--maroon2);font-weight:700;letter-spacing:0.5px}
.lobby-player .dot{width:10px;height:10px;border-radius:50%;background:var(--green);
  box-shadow:0 0 6px rgba(90,158,111,0.35)}

/* ===== HOST SETTINGS ===== */
.settings-toggle{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;
  background:var(--card);border-radius:var(--radius);cursor:pointer;margin:12px 0;border:1px solid rgba(255,255,255,0.04);
  font-weight:600;font-size:14px;color:var(--text);user-select:none;transition:border-color .2s}
.settings-toggle:active{border-color:var(--maroon-dim)}
.settings-toggle .arrow{transition:transform .3s;font-size:12px;color:var(--text2)}
.settings-toggle .arrow.open{transform:rotate(180deg)}
.settings-panel{overflow:hidden;max-height:0;transition:max-height .4s ease;margin:0 0 8px}
.settings-panel.open{max-height:800px}
.settings-inner{padding:12px 14px;background:var(--card);border-radius:var(--radius);border:1px solid rgba(255,255,255,0.04)}
.setting-row{display:flex;align-items:center;justify-content:space-between;padding:10px 0;
  border-bottom:1px solid rgba(255,255,255,0.04)}
.setting-row:last-child{border-bottom:none}
.setting-label{font-size:13px;font-weight:600;color:var(--text2);flex:1}
.setting-label small{display:block;font-weight:400;font-size:11px;color:var(--text3);margin-top:2px}
.setting-control{display:flex;align-items:center;gap:6px}
.setting-control input[type=number]{width:52px;padding:6px 8px;background:var(--card2);border:1px solid rgba(255,255,255,0.06);
  border-radius:8px;color:var(--text);font-size:14px;font-weight:600;text-align:center;
  -moz-appearance:textfield}
.setting-control input[type=number]::-webkit-inner-spin-button{-webkit-appearance:none}
.setting-control select{padding:6px 10px;background:var(--card2);border:1px solid rgba(255,255,255,0.06);
  border-radius:8px;color:var(--text);font-size:13px;font-weight:600;-webkit-appearance:none;appearance:none;
  background-image:url("data:image/svg+xml,%3Csvg width='10' height='6' viewBox='0 0 10 6' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 1l4 4 4-4' stroke='%23a89a8e' fill='none' stroke-width='1.5'/%3E%3C/svg%3E");
  background-repeat:no-repeat;background-position:right 8px center;padding-right:24px}
.setting-control .btn-pm{width:28px;height:28px;border-radius:8px;background:var(--card2);border:1px solid rgba(255,255,255,0.06);
  color:var(--text);font-size:16px;font-weight:700;cursor:pointer;display:flex;align-items:center;justify-content:center;
  transition:background .15s}
.setting-control .btn-pm:active{background:var(--maroon-dim)}

/* ===== FINAL REVEAL ===== */
.reveal-role{display:flex;align-items:center;gap:10px;padding:12px 16px;border-radius:10px;
  margin-bottom:8px;background:var(--card2);border:1px solid rgba(255,255,255,0.03);animation:slideIn .3s}
.reveal-role .rname{flex:1;font-weight:600}
.reveal-role .rtag{padding:4px 12px;border-radius:20px;font-size:12px;font-weight:700;letter-spacing:0.5px}
.reveal-role .rtag.witness{background:rgba(90,158,111,0.15);color:var(--green)}
.reveal-role .rtag.suspect{background:rgba(168,50,50,0.15);color:var(--red)}
.reveal-role .rtag.detective{background:rgba(107,141,181,0.15);color:var(--blue)}
.reveal-role .rtag.judge{background:rgba(201,168,76,0.15);color:var(--gold)}

/* ===== WAITING ===== */
.waiting{text-align:center;color:var(--text2);padding:30px 0}
.waiting .dots::after{content:'...';animation:dotPulse 1.5s infinite}
@keyframes dotPulse{0%{content:'.'} 33%{content:'..'} 66%{content:'...'}}

/* ===== TOAST ===== */
#toast-container{position:fixed;top:16px;left:50%;transform:translateX(-50%);z-index:1000;
  display:flex;flex-direction:column;gap:8px;pointer-events:none;max-width:380px;width:90%}
.toast{padding:12px 18px;border-radius:12px;font-size:14px;font-weight:600;text-align:center;
  animation:toastIn .3s;pointer-events:auto;background:rgba(34,20,24,0.95);border:1px solid rgba(255,255,255,0.06);
  box-shadow:0 8px 32px rgba(0,0,0,0.5);backdrop-filter:blur(8px)}
.toast.success{border-color:rgba(90,158,111,0.3);color:var(--green)}
.toast.error{border-color:rgba(168,50,50,0.3);color:var(--red)}
.toast.info{border-color:rgba(107,141,181,0.3);color:var(--blue)}

/* ===== SPACER ===== */
.spacer{flex:1}
.gap{height:12px}
.gap2{height:20px}

/* ===== ANIMATIONS ===== */
@keyframes popIn{0%{transform:scale(0.8);opacity:0}100%{transform:scale(1);opacity:1}}
@keyframes slideIn{0%{transform:translateX(-10px);opacity:0}100%{transform:translateX(0);opacity:1}}
@keyframes toastIn{0%{transform:translateY(-20px);opacity:0}100%{transform:translateY(0);opacity:1}}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:0.5}}
.pulse{animation:pulse 1.5s infinite}
@keyframes resultReveal{0%{transform:scale(0.85);opacity:0}100%{transform:scale(1);opacity:1}}
@keyframes glowDrift{0%{transform:translate(0,0) scale(1)}100%{transform:translate(60px,40px) scale(1.1)}}
@keyframes floatUp{
  0%{transform:translateY(0) scale(0);opacity:0}
  10%{opacity:0.6;transform:translateY(-8vh) scale(1)}
  80%{opacity:0.15}
  100%{transform:translateY(-100vh) scale(0.3);opacity:0}
}
@keyframes urgentPulse{0%,100%{border-color:rgba(168,50,50,0.05)}50%{border-color:rgba(168,50,50,0.25)}}
@keyframes logoPulse{0%,100%{filter:drop-shadow(0 0 20px rgba(122,32,48,0.2))}50%{filter:drop-shadow(0 0 35px rgba(122,32,48,0.4))}}

/* ===== SCROLL ===== */
.screen::-webkit-scrollbar{width:4px}
.screen::-webkit-scrollbar-thumb{background:var(--text3);border-radius:4px}

/* ===== LOGO ===== */
.logo{margin:40px 0 16px;text-align:center}
.logo-icon{font-size:72px;display:block;margin-bottom:12px;
  filter:drop-shadow(0 0 24px rgba(122,32,48,0.25));animation:logoPulse 4s ease-in-out infinite}

/* ===== CONNECTION STATUS ===== */
.conn-status{display:inline-flex;align-items:center;gap:6px;font-size:12px;color:var(--text3);margin:4px 0}
.conn-dot{width:8px;height:8px;border-radius:50%;background:var(--green);box-shadow:0 0 6px rgba(90,158,111,0.35)}
.conn-dot.off{background:var(--red)}

/* ===== OVERLAY ===== */
.overlay{position:fixed;inset:0;background:rgba(12,6,8,0.92);display:flex;align-items:center;justify-content:center;
  z-index:900;padding:20px;backdrop-filter:blur(4px)}
.overlay .card{max-width:360px;width:100%;text-align:center}
</style>
</head>
<body>

<!-- Atmosphere -->
<div id="atmosphere">
  <div class="ambient-glow g1"></div>
  <div class="ambient-glow g2"></div>
  <div class="ambient-glow g3"></div>
</div>
<div id="vignette"></div>
<div id="urgent-border"></div>

<div id="app">
<div id="lang-btn" onclick="toggleLang()" style="position:fixed;top:12px;right:12px;z-index:999;padding:6px 14px;border-radius:20px;background:var(--card2);border:1px solid rgba(255,255,255,0.08);color:var(--gold);font-size:13px;font-weight:700;cursor:pointer;user-select:none;transition:all .2s;letter-spacing:0">Ø¹Ø±Ø¨ÙŠ</div>
<div id="local-badge" style="display:none;position:fixed;top:12px;left:12px;z-index:999;padding:4px 10px;border-radius:12px;background:var(--green);color:white;font-size:11px;font-weight:700;letter-spacing:0">LOCAL WiFi</div>

<!-- ===== SCREEN: MAIN MENU ===== -->
<div class="screen active" id="s-menu">
  <div class="spacer"></div>
  <div class="logo">
    <span class="logo-icon">&#128373;&#65039;</span>
    <h1>DETECTIVES</h1>
  </div>
  <div class="gap2"></div>
  <button class="btn btn-gold" onclick="showScreen('s-create')">Create Game</button>
  <div class="gap"></div>
  <button class="btn btn-outline" onclick="showScreen('s-join')">Join Game</button>
  <div class="gap"></div>
  <button class="btn btn-outline" onclick="showScreen('s-rules')" style="border-color:var(--text3);color:var(--text2)">How to Play</button>
  <div class="spacer"></div>
</div>

<!-- ===== SCREEN: RULES ===== -->
<div class="screen" id="s-rules">
  <div class="gap2"></div>
  <h2>How to Play</h2>
  <div class="gap"></div>
  <div class="card" style="line-height:1.8;font-size:14px;color:var(--text2)">
    <p><b style="color:var(--gold)">Setup:</b> One player creates a game and shares the 4-letter room code. Everyone else joins on their own device.</p>
    <div class="gap"></div>
    <p><b style="color:var(--text)">Roles are dealt secretly:</b></p>
    <p>&#9878;&#65039; <b>Judge</b> &mdash; No info. Runs the investigation. Makes the final call on every vote.</p>
    <p>&#128065;&#65039; <b>Witness</b> &mdash; Knows the crime location and murder weapon. Must guide the team without being obvious.</p>
    <p>&#128270; <b>Detective</b> &mdash; Gets one subtle clue per round. Shares it aloud and helps the Judge piece things together.</p>
    <p>&#128308; <b>Suspect</b> &mdash; Also knows the location and weapon. Pretends to be a Detective and tries to mislead everyone.</p>
    <div class="gap2"></div>
    <p><b style="color:var(--blue)">Round 1 &mdash; Location:</b> A grid of locations appears. Everyone reads silently, then discusses openly. Detectives share clues, Suspects bluff. The Judge picks the crime scene.</p>
    <div class="gap"></div>
    <p><b style="color:var(--red)">Round 2 &mdash; Weapon:</b> A new grid of weapons. Same flow &mdash; clues, discussion, Judge decides. A wrong pick ends the game immediately.</p>
    <div class="gap"></div>
    <p><b style="color:var(--purple)">Round 3 &mdash; Whodunit:</b> The Judge picks who they think the Suspect is. Then each Suspect secretly guesses who the Witness is.</p>
    <div class="gap2"></div>
    <p><b style="color:var(--green)">Team Wins:</b> Judge gets both words right AND the Witness stays hidden.</p>
    <p><b style="color:var(--red)">Suspects Win:</b> Judge picks a wrong word OR a Suspect correctly identifies the Witness.</p>
  </div>
  <div class="gap2"></div>
  <button class="btn btn-outline" onclick="showScreen('s-menu')">Back</button>
  <div class="gap2"></div>
</div>

<!-- ===== SCREEN: CREATE GAME ===== -->
<div class="screen" id="s-create">
  <div class="spacer"></div>
  <h2>Create Game</h2>
  <h3>You'll be the host</h3>
  <div class="gap2"></div>
  <input type="text" id="host-name-input" placeholder="Your name..." maxlength="20" autocomplete="off">
  <div class="gap2"></div>
  <button class="btn btn-gold" id="btn-create" onclick="createRoom()">Create Room</button>
  <div class="gap"></div>
  <button class="btn btn-outline" onclick="showScreen('s-menu')">Back</button>
  <div class="spacer"></div>
  <div id="create-status" style="text-align:center;font-size:13px;color:var(--text3)"></div>
  <div class="gap"></div>
</div>

<!-- ===== SCREEN: JOIN GAME ===== -->
<div class="screen" id="s-join">
  <div class="spacer"></div>
  <h2>Join Game</h2>
  <h3>Enter the room code</h3>
  <div class="gap2"></div>
  <input type="text" id="join-code-input" placeholder="Room code (4 letters)" maxlength="4" autocomplete="off"
    style="text-align:center;font-size:24px;letter-spacing:8px;text-transform:uppercase;font-weight:800;font-family:'Courier New',monospace">
  <div class="gap"></div>
  <input type="text" id="join-name-input" placeholder="Your name..." maxlength="20" autocomplete="off">
  <div class="gap2"></div>
  <button class="btn btn-gold" id="btn-join" onclick="joinRoom()">Join Room</button>
  <div class="gap"></div>
  <button class="btn btn-outline" onclick="showScreen('s-menu')">Back</button>
  <div class="spacer"></div>
  <div id="join-status" style="text-align:center;font-size:13px;color:var(--text3)"></div>
  <div class="gap"></div>
</div>

<!-- ===== SCREEN: LOBBY ===== -->
<div class="screen" id="s-lobby">
  <div class="gap2"></div>
  <h3>Room Code</h3>
  <div class="room-code" id="lobby-code"></div>
  <button class="btn btn-outline btn-sm" onclick="shareRoom()" style="margin:0 auto 12px;display:block;font-size:13px;padding:8px 20px">
    Share Code
  </button>
  <div class="gap"></div>
  <h3 id="lobby-count">Players (0/10)</h3>
  <div class="gap"></div>
  <div id="lobby-players"></div>

  <!-- Host Settings (host only) -->
  <div id="host-settings-wrap" style="display:none">
    <div class="settings-toggle" onclick="toggleSettings()">
      <span>&#9881;&#65039; Game Settings</span>
      <span class="arrow" id="settings-arrow">&#9660;</span>
    </div>
    <div class="settings-panel" id="settings-panel">
      <div class="settings-inner">
        <div class="setting-row">
          <div class="setting-label">Min Players<small>Minimum to start</small></div>
          <div class="setting-control">
            <button class="btn-pm" onclick="adjSetting('minPlayers',-1)">-</button>
            <input type="number" id="set-minPlayers" value="4" min="2" max="10" onchange="onSettingChange()">
            <button class="btn-pm" onclick="adjSetting('minPlayers',1)">+</button>
          </div>
        </div>
        <div class="setting-row">
          <div class="setting-label">Max Players<small>Room capacity</small></div>
          <div class="setting-control">
            <button class="btn-pm" onclick="adjSetting('maxPlayers',-1)">-</button>
            <input type="number" id="set-maxPlayers" value="10" min="2" max="20" onchange="onSettingChange()">
            <button class="btn-pm" onclick="adjSetting('maxPlayers',1)">+</button>
          </div>
        </div>
        <div class="setting-row">
          <div class="setting-label">Suspects<small>Auto scales with players</small></div>
          <div class="setting-control">
            <select id="set-suspects" onchange="onSettingChange()">
              <option value="auto">Auto</option>
              <option value="1">1</option>
              <option value="2">2</option>
              <option value="3">3</option>
              <option value="4">4</option>
            </select>
          </div>
        </div>
        <div class="setting-row">
          <div class="setting-label">Grid Size<small>Words per grid</small></div>
          <div class="setting-control">
            <select id="set-gridSize" onchange="onSettingChange()">
              <option value="4">2 &times; 2 (4)</option>
              <option value="9" selected>3 &times; 3 (9)</option>
              <option value="16">4 &times; 4 (16)</option>
            </select>
          </div>
        </div>
        <div class="setting-row">
          <div class="setting-label">Prep Time<small>Silent reading phase</small></div>
          <div class="setting-control">
            <button class="btn-pm" onclick="adjSetting('prepTime',-5)">-</button>
            <input type="number" id="set-prepTime" value="30" min="10" max="120" step="5" onchange="onSettingChange()">
            <button class="btn-pm" onclick="adjSetting('prepTime',5)">+</button>
            <span style="font-size:12px;color:var(--text3)">s</span>
          </div>
        </div>
        <div class="setting-row">
          <div class="setting-label">Discussion Time<small>Team discussion phase</small></div>
          <div class="setting-control">
            <button class="btn-pm" onclick="adjSetting('discussTime',-10)">-</button>
            <input type="number" id="set-discussTime" value="90" min="30" max="300" step="10" onchange="onSettingChange()">
            <button class="btn-pm" onclick="adjSetting('discussTime',10)">+</button>
            <span style="font-size:12px;color:var(--text3)">s</span>
          </div>
        </div>
        <div class="setting-row">
          <div class="setting-label">Judge Time<small>Decision timer</small></div>
          <div class="setting-control">
            <button class="btn-pm" onclick="adjSetting('judgeTime',-5)">-</button>
            <input type="number" id="set-judgeTime" value="15" min="10" max="60" step="5" onchange="onSettingChange()">
            <button class="btn-pm" onclick="adjSetting('judgeTime',5)">+</button>
            <span style="font-size:12px;color:var(--text3)">s</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="spacer"></div>
  <div id="lobby-role-preview" class="card" style="font-size:13px;color:var(--text2);display:none;text-align:center;margin-bottom:12px"></div>
  <button class="btn btn-gold" id="btn-start-game" style="display:none" onclick="hostStartGame()">Start Game</button>
  <p id="lobby-wait" class="waiting" style="display:none">Waiting for host to start<span class="dots"></span></p>
  <div class="gap"></div>
  <button class="btn btn-outline" onclick="leaveGame()" style="border-color:var(--red);color:var(--red);font-size:14px">Leave Game</button>
  <div class="gap"></div>
</div>

<!-- ===== SCREEN: ROLE REVEAL ===== -->
<div class="screen" id="s-role">
  <div class="spacer"></div>
  <h3>Your Secret Role</h3>
  <div class="role-card-container">
    <div class="role-card" id="role-card" onclick="flipRole()">
      <div class="face front">
        <span style="font-size:56px">&#10068;</span>
      </div>
      <div class="face back card-glow" id="role-back"></div>
    </div>
  </div>
  <button class="btn btn-gold" id="btn-ready" style="display:none" onclick="confirmReady()">I'm Ready</button>
  <p id="ready-wait" class="waiting" style="display:none">Waiting for others<span class="dots"></span></p>
  <div class="spacer"></div>
</div>

<!-- ===== SCREEN: LOADING / WAITING ===== -->
<div class="screen" id="s-loading">
  <div class="spacer"></div>
  <div style="text-align:center">
    <div id="loading-icon" style="font-size:48px;margin-bottom:16px">&#9203;</div>
    <h2 id="loading-title">Waiting for Players</h2>
    <p id="loading-sub" class="subtitle" style="margin-top:8px">Everyone needs to confirm their role...</p>
    <div class="gap2"></div>
    <div id="loading-progress" style="display:none">
      <div style="background:var(--card2);border-radius:10px;height:12px;overflow:hidden;margin:0 20px">
        <div id="loading-bar-fill" style="height:100%;width:0%;background:linear-gradient(90deg,var(--gold),var(--gold2));border-radius:10px;transition:width .3s"></div>
      </div>
      <div class="gap"></div>
    </div>
    <div class="waiting"><span class="dots"></span></div>
  </div>
  <div class="spacer"></div>
</div>

<!-- ===== SCREEN: GAME (prep + discussion) ===== -->
<div class="screen" id="s-game">
  <div class="gap"></div>
  <div id="game-badge" style="text-align:center"></div>
  <h2 id="game-title"></h2>
  <div id="game-role-info"></div>
  <div class="word-grid" id="game-grid"></div>
  <div class="timer-wrap">
    <div class="timer-ring"><svg viewBox="0 0 100 100"><circle class="bg" cx="50" cy="50" r="44"/><circle class="fg" id="game-timer-fg" cx="50" cy="50" r="44"/></svg><div class="timer-digits" id="game-timer-digits">0</div></div>
    <div class="timer-label" id="game-timer-label">PREPARATION</div>
  </div>
  <div class="gap"></div>
  <p style="text-align:center;font-size:13px;color:var(--text3)" id="game-hint-text"></p>
  <div class="gap"></div>
  <button class="btn btn-outline" id="btn-end-discuss" style="display:none" onclick="endDiscussionEarly()">End Discussion Early</button>
  <div class="gap"></div>
</div>

<!-- ===== SCREEN: JUDGE PICK ===== -->
<div class="screen" id="s-judge">
  <div class="gap"></div>
  <div id="judge-badge" style="text-align:center"></div>
  <h2 id="judge-title"></h2>
  <h3 id="judge-sub"></h3>
  <div id="judge-role-info"></div>
  <div class="gap"></div>
  <div class="word-grid" id="judge-grid"></div>
  <div class="player-list" id="judge-players" style="display:none"></div>
  <div class="timer-wrap" id="judge-timer-wrap">
    <div class="timer-ring"><svg viewBox="0 0 100 100"><circle class="bg" cx="50" cy="50" r="44"/><circle class="fg" id="judge-timer-fg" cx="50" cy="50" r="44"/></svg><div class="timer-digits" id="judge-timer-digits">15</div></div>
    <div class="timer-label" style="color:var(--red)">DECIDE OR SUSPECTS WIN</div>
  </div>
  <div class="spacer"></div>
  <div id="judge-waiting" class="waiting" style="display:none">Waiting for Judge's decision<span class="dots"></span></div>
  <button class="btn btn-gold" id="btn-judge-confirm" style="display:none" disabled onclick="judgeConfirmPick()">Confirm Selection</button>
  <div class="gap2"></div>
</div>

<!-- ===== SCREEN: STAGE RESULT ===== -->
<div class="screen" id="s-result">
  <div class="spacer"></div>
  <div id="result-content" style="text-align:center"></div>
  <div class="gap2"></div>
  <button class="btn btn-gold" id="btn-next-stage" style="display:none" onclick="requestNextStage()">Next Stage</button>
  <p id="result-wait" class="waiting" style="display:none">Continuing<span class="dots"></span></p>
  <div class="spacer"></div>
</div>

<!-- ===== SCREEN: SUSPECT GUESS ===== -->
<div class="screen" id="s-suspect">
  <div class="gap2"></div>
  <div class="stage-badge sus">&#128308; Suspect's Turn</div>
  <div id="suspect-content"></div>
  <div class="spacer"></div>
  <button class="btn btn-red" id="btn-suspect-confirm" style="display:none" disabled onclick="suspectConfirmVote()">Confirm Guess</button>
  <p id="suspect-wait" class="waiting" style="display:none">Suspects are voting<span class="dots"></span></p>
  <div class="gap2"></div>
</div>

<!-- ===== SCREEN: GAME OVER ===== -->
<div class="screen" id="s-gameover">
  <div class="spacer"></div>
  <div id="gameover-content" style="text-align:center"></div>
  <div class="gap2"></div>
  <div id="gameover-roles"></div>
  <div class="gap2"></div>
  <button class="btn btn-gold" id="btn-play-again" style="display:none" onclick="playAgain()">Play Again</button>
  <div class="gap"></div>
  <button class="btn btn-outline" onclick="leaveGame()">Leave Game</button>
  <div class="spacer"></div>
</div>

</div>

<!-- Disconnect overlay -->
<div class="overlay" id="disconnect-overlay" style="display:none">
  <div class="card card-glow">
    <div style="font-size:48px;margin-bottom:12px">&#9888;&#65039;</div>
    <h2 style="color:var(--red)">Disconnected</h2>
    <p class="subtitle" id="disconnect-msg">Connection lost.</p>
    <div class="gap2"></div>
    <button class="btn btn-gold" onclick="location.reload()">Back to Menu</button>
  </div>
</div>

<div id="toast-container"></div>

<script>
// ======================== WORD BANKS ========================
const LOCATIONS = [
  'Rooftop','Casino','Kitchen','Subway','Library','Hospital','Beach','Airport','Museum',
  'Warehouse','Mansion','Garage','School','Theater','Docks','Prison','Church','Penthouse',
  'Forest','Market','Lab','Courtroom','Hotel','Stadium','Cemetery','Lighthouse','Bunker',
  'Yacht','Train Station','Nightclub','Office','Parking Lot','Bank','Restaurant','Gym',
  'Farm','Aquarium','Observatory','Mall','Spa'
];
const WEAPONS = [
  'Knife','Poison','Gun','Rope','Wrench','Candlestick','Axe','Crowbar','Scissors',
  'Hammer','Syringe','Brick','Pipe','Crossbow','Chainsaw','Shovel','Ice Pick','Bat',
  'Dagger','Grenade','Taser','Machete','Mallet','Scalpel','Drill','Trophy','Frying Pan',
  'Whip','Pitchfork','Hatchet','Spear','Saw','Torch','Bolt Cutter','Chain','Stiletto',
  'Blowdart','Garrote','Flare Gun','Sledgehammer'
];

// ======================== HINT BANK ========================
// Hints should be subtle â€” evocative but not dead giveaways
const HINTS = {
  // Locations
  'Rooftop':['vertigo','pigeons gather','above it all','antennas'],
  'Casino':['lucky sevens','velvet tables','high roller','all in'],
  'Kitchen':['something burning','hot oil','cutting board','timer ding'],
  'Subway':['rumbling below','yellow line','crowded platform','echoing'],
  'Library':['whisper only','dusty spines','card catalog','overdue'],
  'Hospital':['antiseptic smell','long hallway','visiting hours','pale green walls'],
  'Beach':['tide coming in','sunscreen','footprints vanish','driftwood'],
  'Airport':['final call','overhead announcements','time zones','conveyor belt'],
  'Museum':['do not touch','velvet rope','ancient things','guided group'],
  'Warehouse':['echo in the dark','loading bay','pallets','high ceiling'],
  'Mansion':['wrought iron gate','many rooms','portrait hall','old money'],
  'Garage':['oil puddle','concrete floor','cluttered walls','motor smell'],
  'School':['locker slam','hallway pass','pop quiz','recess bell'],
  'Theater':['intermission','velvet seats','standing ovation','dimming lights'],
  'Docks':['salt air','creaking wood','rope coils','tide schedule'],
  'Prison':['headcount','concrete yard','orange jumpsuit','no windows'],
  'Church':['echoing hymns','quiet reverence','colored light','Sunday morning'],
  'Penthouse':['private elevator','city below','floor-to-ceiling','corner unit'],
  'Forest':['snapping twigs','canopy','moss-covered','birdsong'],
  'Market':['haggling','early morning','colorful awnings','cash only'],
  'Lab':['goggles required','Bunsen burner','hypothesis','safety shower'],
  'Courtroom':['all rise','sworn in','objection','deliberation'],
  'Hotel':['room service','minibar','wake-up call','checkout'],
  'Stadium':['the wave','halftime','nosebleed seats','season pass'],
  'Cemetery':['iron fence','quiet rows','wilted petals','old dates'],
  'Lighthouse':['foghorn','spiral stairs','rocky shore','keeper'],
  'Bunker':['thick walls','provisions','sealed door','no signal'],
  'Yacht':['port side','seasick','mahogany deck','horizon line'],
  'Train Station':['announcement board','last stop','whistling','track 9'],
  'Nightclub':['strobe lights','bass drop','velvet rope','2 AM'],
  'Office':['fluorescent hum','coffee machine','9 to 5','swivel chair'],
  'Parking Lot':['yellow lines','ticket stub','concrete pillars','level B2'],
  'Bank':['marble floor','waiting line','bulletproof glass','safety deposit'],
  'Restaurant':['reservation','specials board','cloth napkins','candlelit'],
  'Gym':['rubber mats','mirror wall','towel rack','protein shake'],
  'Farm':['sunrise chores','muddy boots','red structure','roosters'],
  'Aquarium':['blue glow','tunnel walkway','feeding time','bubbling'],
  'Observatory':['clear night','rotating roof','high altitude','red light only'],
  'Mall':['food court','window displays','holiday rush','gift wrapping'],
  'Spa':['cucumber water','dim lighting','soft robes','hot stones'],
  // Weapons
  'Knife':['dinner table','folding','serrated edge','pocket-sized'],
  'Poison':['odorless','drop by drop','bitter aftertaste','slow-acting'],
  'Gun':['holster','safety off','smoking','six chambers'],
  'Rope':['rough hands','sailor knot','fraying','taut'],
  'Wrench':['turning motion','pipe fitting','rust stains','adjustable'],
  'Candlestick':['dripping wax','flickering','dinner party','brass weight'],
  'Axe':['splitting sound','wood chips','chopping block','heavy swing'],
  'Crowbar':['leverage','pry open','rusty red','curved end'],
  'Scissors':['left-handed','paper cuts','snip sound','two loops'],
  'Hammer':['bent nails','claw end','thumb injury','toolbelt'],
  'Syringe':['small dose','plunger','sharp tip','measured marks'],
  'Brick':['crumbling mortar','terracotta','heavy throw','rough edges'],
  'Pipe':['clanking','threaded end','under the sink','lead'],
  'Crossbow':['string tension','scope','silent shot','quiver'],
  'Chainsaw':['pull cord','two-stroke','vibration','ear protection'],
  'Shovel':['blisters','pointed tip','fresh dirt','deep hole'],
  'Ice Pick':['mountain gear','narrow point','clear block','one spike'],
  'Bat':['home run','pine tar','cracking sound','Louisville'],
  'Dagger':['sheath','ornamental','cross guard','close quarters'],
  'Grenade':['fragmentation','count to three','olive drab','pull ring'],
  'Taser':['clicking sound','two prongs','compliance','battery pack'],
  'Machete':['undergrowth','broad blade','humid climate','rusted'],
  'Mallet':['flat face','croquet lawn','rubber version','gentle force'],
  'Scalpel':['number 10 blade','steady hand','sterile tray','precise cut'],
  'Drill':['chuck key','spiral bit','cordless','pilot hole'],
  'Trophy':['engraved plate','shelf display','golden figure','first place'],
  'Frying Pan':['sizzling','black residue','handle hot','seasoned'],
  'Whip':['braided','snap sound','cowhide','long reach'],
  'Pitchfork':['three tines','hay bale','barn tool','wooden shaft'],
  'Hatchet':['belt loop','kindling','hand-sized','tomahawk'],
  'Spear':['shaft','thrown far','flint tip','ancient hunt'],
  'Saw':['push-pull','jagged teeth','fine dust','straight cut'],
  'Torch':['flickering','wrapped cloth','night march','pine resin'],
  'Bolt Cutter':['snapping jaws','padlock','long handles','hardened steel'],
  'Chain':['rattling','linked','anchor line','cold metal'],
  'Stiletto':['needle-thin','spring-loaded','Italian craft','concealed'],
  'Blowdart':['hollow reed','lung power','tiny projectile','jungle'],
  'Garrote':['piano wire','from behind','thin line','silent'],
  'Flare Gun':['red sky','distress','single shot','burning arc'],
  'Sledgehammer':['two-handed grip','concrete dust','full swing','10 pounds']
};

function getHint(word) {
  const bank = currentLang === 'ar' ? (HINTS_AR[word] || HINTS[word]) : HINTS[word];
  if (!bank) return currentLang === 'ar' ? 'ØºØ§Ù…Ø¶' : 'mysterious';
  return bank[Math.floor(Math.random() * bank.length)];
}

// ======================== CARD ART GENERATION ========================
// Each word maps to [emoji, darkBg, accentColor] for themed card art
const CARD_ART = {
  // ---- Locations ----
  'Rooftop':['ğŸ™ï¸','#1a1a3e','#e05050'],'Casino':['ğŸ°','#2a0a0a','#ffd700'],
  'Kitchen':['ğŸ³','#3a2010','#f0a030'],'Subway':['ğŸš‡','#1a1a2a','#4488cc'],
  'Library':['ğŸ“š','#2a1a10','#c8a050'],'Hospital':['ğŸ¥','#0a1a2a','#40a0d0'],
  'Beach':['ğŸ–ï¸','#0a2030','#f0c040'],'Airport':['âœˆï¸','#1a2030','#6090c0'],
  'Museum':['ğŸ›ï¸','#2a2010','#d0b060'],'Warehouse':['ğŸ“¦','#1a1510','#8a7050'],
  'Mansion':['ğŸ°','#1a1030','#b060d0'],'Garage':['ğŸ”§','#1a1a1a','#808080'],
  'School':['ğŸ«','#1a1020','#d04040'],'Theater':['ğŸ­','#2a0a10','#e06030'],
  'Docks':['âš“','#0a1520','#4080a0'],'Prison':['â›“ï¸','#1a1a1a','#a0a0a0'],
  'Church':['â›ª','#1a1030','#c0a0e0'],'Penthouse':['ğŸŒƒ','#0a0a2a','#f0d060'],
  'Forest':['ğŸŒ²','#0a200a','#40a040'],'Market':['ğŸ›’','#1a200a','#e0a020'],
  'Lab':['ğŸ§ª','#0a1a20','#40d080'],'Courtroom':['âš–ï¸','#1a1510','#c0a040'],
  'Hotel':['ğŸ¨','#1a1530','#5080d0'],'Stadium':['ğŸŸï¸','#0a1a0a','#40b060'],
  'Cemetery':['âš°ï¸','#0a0a10','#6060a0'],'Lighthouse':['ğŸ—¼','#0a1530','#f0e060'],
  'Bunker':['ğŸª–','#0a100a','#607050'],'Yacht':['â›µ','#0a1020','#40a0e0'],
  'Train Station':['ğŸš‚','#1a1510','#c04030'],'Nightclub':['ğŸª©','#1a0a20','#d040e0'],
  'Office':['ğŸ’¼','#101520','#4070a0'],'Parking Lot':['ğŸ…¿ï¸','#101010','#5070a0'],
  'Bank':['ğŸ¦','#0a1a10','#40a060'],'Restaurant':['ğŸ½ï¸','#2a100a','#e06040'],
  'Gym':['ğŸ‹ï¸','#1a150a','#e08020'],'Farm':['ğŸŒ¾','#101a0a','#80a030'],
  'Aquarium':['ğŸ ','#0a1520','#30b0c0'],'Observatory':['ğŸ”­','#0a0a20','#6060d0'],
  'Mall':['ğŸ›ï¸','#200a1a','#e060a0'],'Spa':['ğŸ§–','#0a1a1a','#60c0b0'],
  // ---- Weapons ----
  'Knife':['ğŸ”ª','#1a1a1a','#a0a0c0'],'Poison':['â˜ ï¸','#0a1a0a','#60d060'],
  'Gun':['ğŸ”«','#1a1a20','#6070a0'],'Rope':['ğŸª¢','#1a150a','#a08040'],
  'Wrench':['ğŸ”§','#101520','#8090a0'],'Candlestick':['ğŸ•¯ï¸','#1a1510','#f0d040'],
  'Axe':['ğŸª“','#1a100a','#a06030'],'Crowbar':['ğŸª','#1a1a1a','#7080a0'],
  'Scissors':['âœ‚ï¸','#1a1a1a','#c04040'],'Hammer':['ğŸ”¨','#1a150a','#a07030'],
  'Syringe':['ğŸ’‰','#101520','#d04050'],'Brick':['ğŸ§±','#1a0a0a','#c06030'],
  'Pipe':['ğŸªˆ','#1a1a1a','#7080a0'],'Crossbow':['ğŸ¹','#1a150a','#806030'],
  'Chainsaw':['â›“ï¸â€ğŸ’¥','#1a1510','#e08020'],'Shovel':['â›ï¸','#1a150a','#907040'],
  'Ice Pick':['ğŸ§Š','#0a1520','#80c0e0'],'Bat':['ğŸ','#1a150a','#a08040'],
  'Dagger':['ğŸ—¡ï¸','#0a0a1a','#a0a0c0'],'Grenade':['ğŸ’£','#0a0a0a','#607050'],
  'Taser':['âš¡','#0a0a1a','#f0e040'],'Machete':['âš”ï¸','#0a1a0a','#70a060'],
  'Mallet':['ğŸªµ','#1a150a','#b09050'],'Scalpel':['ğŸ©»','#0a1020','#80b0d0'],
  'Drill':['ğŸ”©','#1a1a0a','#e0c020'],'Trophy':['ğŸ†','#1a150a','#f0c020'],
  'Frying Pan':['ğŸ³','#1a1a1a','#707070'],'Whip':['ğŸ¦¯','#1a100a','#905030'],
  'Pitchfork':['ğŸ”±','#1a0a0a','#c03030'],'Hatchet':['ğŸª“','#1a1510','#906040'],
  'Spear':['ğŸ¯','#1a150a','#907040'],'Saw':['ğŸªš','#1a1a1a','#a09070'],
  'Torch':['ğŸ”¥','#1a0a0a','#f08020'],'Bolt Cutter':['âœ‚ï¸','#1a1a20','#707080'],
  'Chain':['â›“ï¸','#101015','#909090'],'Stiletto':['ğŸ—¡ï¸','#101020','#b0a0d0'],
  'Blowdart':['ğŸ’¨','#0a1a0a','#60a050'],'Garrote':['ğŸª¡','#1a1a1a','#808090'],
  'Flare Gun':['ğŸ†','#1a0a10','#f04060'],'Sledgehammer':['âš’ï¸','#1a1a1a','#808080'],
};

// Get icon data for a word (emoji + accent color)
function getCardArt(word) {
  return CARD_ART[word] || ['â“','#1a1a1a','#808080'];
}

// ======================== ARABIC WORD & HINT TRANSLATIONS ========================
const WORDS_AR = {
  // Locations
  'Rooftop':'Ø³Ø·Ø­ Ø§Ù„Ù…Ø¨Ù†Ù‰','Casino':'ÙƒØ§Ø²ÙŠÙ†Ùˆ','Kitchen':'Ù…Ø·Ø¨Ø®','Subway':'Ù…ØªØ±Ùˆ Ø§Ù„Ø£Ù†ÙØ§Ù‚',
  'Library':'Ù…ÙƒØªØ¨Ø©','Hospital':'Ù…Ø³ØªØ´ÙÙ‰','Beach':'Ø´Ø§Ø·Ø¦','Airport':'Ù…Ø·Ø§Ø±',
  'Museum':'Ù…ØªØ­Ù','Warehouse':'Ù…Ø³ØªÙˆØ¯Ø¹','Mansion':'Ù‚ØµØ±','Garage':'Ù…Ø±Ø¢Ø¨',
  'School':'Ù…Ø¯Ø±Ø³Ø©','Theater':'Ù…Ø³Ø±Ø­','Docks':'Ø£Ø±ØµÙØ© Ø§Ù„Ù…ÙŠÙ†Ø§Ø¡','Prison':'Ø³Ø¬Ù†',
  'Church':'ÙƒÙ†ÙŠØ³Ø©','Penthouse':'Ø´Ù‚Ø© Ø¹Ù„ÙˆÙŠØ©','Forest':'ØºØ§Ø¨Ø©','Market':'Ø³ÙˆÙ‚',
  'Lab':'Ù…Ø®ØªØ¨Ø±','Courtroom':'Ù‚Ø§Ø¹Ø© Ø§Ù„Ù…Ø­ÙƒÙ…Ø©','Hotel':'ÙÙ†Ø¯Ù‚','Stadium':'Ù…Ù„Ø¹Ø¨',
  'Cemetery':'Ù…Ù‚Ø¨Ø±Ø©','Lighthouse':'Ù…Ù†Ø§Ø±Ø©','Bunker':'Ù…Ù„Ø¬Ø£','Yacht':'ÙŠØ®Øª',
  'Train Station':'Ù…Ø­Ø·Ø© Ø§Ù„Ù‚Ø·Ø§Ø±','Nightclub':'Ù…Ù„Ù‡Ù‰ Ù„ÙŠÙ„ÙŠ','Office':'Ù…ÙƒØªØ¨',
  'Parking Lot':'Ù…ÙˆÙ‚Ù Ø³ÙŠØ§Ø±Ø§Øª','Bank':'Ø¨Ù†Ùƒ','Restaurant':'Ù…Ø·Ø¹Ù…','Gym':'ØµØ§Ù„Ø© Ø±ÙŠØ§Ø¶ÙŠØ©',
  'Farm':'Ù…Ø²Ø±Ø¹Ø©','Aquarium':'Ø­ÙˆØ¶ Ø£Ø³Ù…Ø§Ùƒ','Observatory':'Ù…Ø±ØµØ¯ ÙÙ„ÙƒÙŠ','Mall':'Ù…Ø±ÙƒØ² ØªØ¬Ø§Ø±ÙŠ','Spa':'Ù…Ù†ØªØ¬Ø¹ ØµØ­ÙŠ',
  // Weapons
  'Knife':'Ø³ÙƒÙŠÙ†','Poison':'Ø³ÙÙ…','Gun':'Ù…Ø³Ø¯Ø³','Rope':'Ø­Ø¨Ù„',
  'Wrench':'Ù…ÙØªØ§Ø­ Ø±Ø¨Ø·','Candlestick':'Ø´Ù…Ø¹Ø¯Ø§Ù†','Axe':'ÙØ£Ø³','Crowbar':'Ø¹ØªÙ„Ø©',
  'Scissors':'Ù…Ù‚Øµ','Hammer':'Ù…Ø·Ø±Ù‚Ø©','Syringe':'Ø­Ù‚Ù†Ø©','Brick':'Ø·ÙˆØ¨Ø©',
  'Pipe':'Ø£Ù†Ø¨ÙˆØ¨','Crossbow':'Ù‚ÙˆØ³ Ù†Ø´Ø§Ø¨','Chainsaw':'Ù…Ù†Ø´Ø§Ø± ÙƒÙ‡Ø±Ø¨Ø§Ø¦ÙŠ','Shovel':'Ù…Ø¬Ø±ÙØ©',
  'Ice Pick':'Ù…Ø¹ÙˆÙ„ Ø«Ù„Ø¬','Bat':'Ù…Ø¶Ø±Ø¨','Dagger':'Ø®Ù†Ø¬Ø±','Grenade':'Ù‚Ù†Ø¨Ù„Ø© ÙŠØ¯ÙˆÙŠØ©',
  'Taser':'ØµØ§Ø¹Ù‚ ÙƒÙ‡Ø±Ø¨Ø§Ø¦ÙŠ','Machete':'Ø³Ø§Ø·ÙˆØ±','Mallet':'Ù…Ø·Ø±Ù‚Ø© Ø®Ø´Ø¨ÙŠØ©','Scalpel':'Ù…Ø´Ø±Ø·',
  'Drill':'Ù…Ø«Ù‚Ø§Ø¨','Trophy':'ÙƒØ£Ø³','Frying Pan':'Ù…Ù‚Ù„Ø§Ø©','Whip':'Ø³ÙˆØ·',
  'Pitchfork':'Ø´ÙˆÙƒØ© Ù…Ø²Ø±Ø¹Ø©','Hatchet':'Ø¨Ù„Ø·Ø©','Spear':'Ø±Ù…Ø­','Saw':'Ù…Ù†Ø´Ø§Ø±',
  'Torch':'Ù…Ø´Ø¹Ù„','Bolt Cutter':'Ù‚Ø§Ø·Ø¹ Ø£Ù‚ÙØ§Ù„','Chain':'Ø³Ù„Ø³Ù„Ø©','Stiletto':'Ø®Ù†Ø¬Ø± Ø±ÙÙŠØ¹',
  'Blowdart':'Ù†ÙØ§Ø«Ø© Ø³Ù‡Ø§Ù…','Garrote':'Ø³Ù„Ùƒ Ø®Ù†Ù‚','Flare Gun':'Ù…Ø³Ø¯Ø³ Ø¥Ø´Ø§Ø±Ø©','Sledgehammer':'Ù…Ø·Ø±Ù‚Ø© Ø«Ù‚ÙŠÙ„Ø©'
};

const HINTS_AR = {
  // Locations
  'Rooftop':['Ø¯ÙˆØ§Ø± Ø§Ù„Ù…Ø±ØªÙØ¹Ø§Øª','Ø­Ù…Ø§Ù… ÙŠØªØ¬Ù…Ø¹','ÙÙˆÙ‚ ÙƒÙ„ Ø´ÙŠØ¡','Ù‡ÙˆØ§Ø¦ÙŠØ§Øª'],
  'Casino':['Ø³Ø¨Ø¹Ø§Øª Ù…Ø­Ø¸ÙˆØ¸Ø©','Ø·Ø§ÙˆÙ„Ø§Øª Ù…Ø®Ù…Ù„ÙŠØ©','Ø±Ù‡Ø§Ù† Ø¹Ø§Ù„ÙŠ','Ø§Ù„ÙƒÙ„ Ø¯Ø§Ø®Ù„'],
  'Kitchen':['Ø´ÙŠØ¡ ÙŠØ­ØªØ±Ù‚','Ø²ÙŠØª Ø³Ø§Ø®Ù†','Ù„ÙˆØ­ ØªÙ‚Ø·ÙŠØ¹','Ø¬Ø±Ø³ Ø§Ù„Ù…Ø¤Ù‚Øª'],
  'Subway':['Ù‡Ø¯ÙŠØ± ØªØ­Øª Ø§Ù„Ø£Ø±Ø¶','Ø®Ø· Ø£ØµÙØ±','Ø±ØµÙŠÙ Ù…Ø²Ø¯Ø­Ù…','ØµØ¯Ù‰'],
  'Library':['Ù‡Ù…Ø³ ÙÙ‚Ø·','Ø£ØºÙ„ÙØ© Ù…ØºØ¨Ø±Ø©','ÙÙ‡Ø±Ø³ Ø¨Ø·Ø§Ù‚Ø§Øª','Ù…ØªØ£Ø®Ø± Ø§Ù„Ø¥Ø¹Ø§Ø¯Ø©'],
  'Hospital':['Ø±Ø§Ø¦Ø­Ø© Ù…Ø¹Ù‚Ù…','Ù…Ù…Ø± Ø·ÙˆÙŠÙ„','Ø³Ø§Ø¹Ø§Øª Ø²ÙŠØ§Ø±Ø©','Ø¬Ø¯Ø±Ø§Ù† Ø®Ø¶Ø±Ø§Ø¡ Ø¨Ø§Ù‡ØªØ©'],
  'Beach':['Ø§Ù„Ù…Ø¯ Ù‚Ø§Ø¯Ù…','ÙˆØ§Ù‚ÙŠ Ø´Ù…Ø³','Ø¢Ø«Ø§Ø± Ø£Ù‚Ø¯Ø§Ù… ØªØ®ØªÙÙŠ','Ø®Ø´Ø¨ Ø·Ø§ÙÙ'],
  'Airport':['Ø§Ù„Ù†Ø¯Ø§Ø¡ Ø§Ù„Ø£Ø®ÙŠØ±','Ø¥Ø¹Ù„Ø§Ù†Ø§Øª Ø¹Ù„ÙˆÙŠØ©','Ù…Ù†Ø§Ø·Ù‚ Ø²Ù…Ù†ÙŠØ©','Ø­Ø²Ø§Ù… Ù†Ø§Ù‚Ù„'],
  'Museum':['Ù…Ù…Ù†ÙˆØ¹ Ø§Ù„Ù„Ù…Ø³','Ø­Ø¨Ù„ Ù…Ø®Ù…Ù„ÙŠ','Ø£Ø´ÙŠØ§Ø¡ Ù‚Ø¯ÙŠÙ…Ø©','Ù…Ø¬Ù…ÙˆØ¹Ø© Ø¨Ù…Ø±Ø´Ø¯'],
  'Warehouse':['ØµØ¯Ù‰ ÙÙŠ Ø§Ù„Ø¸Ù„Ø§Ù…','Ø±ØµÙŠÙ ØªØ­Ù…ÙŠÙ„','Ù…Ù†ØµØ§Øª Ù†Ù‚Ù„','Ø³Ù‚Ù Ø¹Ø§Ù„Ù'],
  'Mansion':['Ø¨ÙˆØ§Ø¨Ø© Ø­Ø¯ÙŠØ¯ Ù…Ø²Ø®Ø±Ù','ØºØ±Ù ÙƒØ«ÙŠØ±Ø©','Ø±ÙˆØ§Ù‚ ØµÙˆØ±','Ø«Ø±ÙˆØ© Ù‚Ø¯ÙŠÙ…Ø©'],
  'Garage':['Ø¨Ù‚Ø¹Ø© Ø²ÙŠØª','Ø£Ø±Ø¶ÙŠØ© Ø®Ø±Ø³Ø§Ù†ÙŠØ©','Ø¬Ø¯Ø±Ø§Ù† Ù…ÙƒØ¯Ø³Ø©','Ø±Ø§Ø¦Ø­Ø© Ù…Ø­Ø±Ùƒ'],
  'School':['ØµÙÙ‚ Ø§Ù„Ø®Ø²Ø§Ù†Ø©','Ø¥Ø°Ù† Ù…Ø±ÙˆØ±','Ø§Ø®ØªØ¨Ø§Ø± Ù…ÙØ§Ø¬Ø¦','Ø¬Ø±Ø³ Ø§Ù„Ø§Ø³ØªØ±Ø§Ø­Ø©'],
  'Theater':['Ø§Ø³ØªØ±Ø§Ø­Ø©','Ù…Ù‚Ø§Ø¹Ø¯ Ù…Ø®Ù…Ù„ÙŠØ©','ØªØµÙÙŠÙ‚ Ø­Ø§Ø±','Ø£Ø¶ÙˆØ§Ø¡ Ø®Ø§ÙØªØ©'],
  'Docks':['Ù‡ÙˆØ§Ø¡ Ù…Ø§Ù„Ø­','Ø®Ø´Ø¨ ÙŠØµØ±Ù‘','Ù„ÙØ§Ø¦Ù Ø­Ø¨Ø§Ù„','Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ø¯'],
  'Prison':['Ø¹Ø¯ Ø§Ù„Ø±Ø¤ÙˆØ³','Ø³Ø§Ø­Ø© Ø®Ø±Ø³Ø§Ù†ÙŠØ©','Ø¨Ø¯Ù„Ø© Ø¨Ø±ØªÙ‚Ø§Ù„ÙŠØ©','Ø¨Ù„Ø§ Ù†ÙˆØ§ÙØ°'],
  'Church':['ØªØ±Ø§Ù†ÙŠÙ… ØªØªØ±Ø¯Ø¯','Ù‡Ø¯ÙˆØ¡ ÙˆÙ‚Ø§Ø±','Ø¶ÙˆØ¡ Ù…Ù„ÙˆÙ†','ØµØ¨Ø§Ø­ Ø§Ù„Ø£Ø­Ø¯'],
  'Penthouse':['Ù…ØµØ¹Ø¯ Ø®Ø§Øµ','Ø§Ù„Ù…Ø¯ÙŠÙ†Ø© ÙÙŠ Ø§Ù„Ø£Ø³ÙÙ„','Ù†ÙˆØ§ÙØ° Ù…Ù† Ø§Ù„Ø£Ø±Ø¶ Ù„Ù„Ø³Ù‚Ù','ÙˆØ­Ø¯Ø© Ø²Ø§ÙˆÙŠØ©'],
  'Forest':['Ø£ØºØµØ§Ù† ØªØªÙƒØ³Ø±','Ø¸Ù„Ø§Ù„ Ø§Ù„Ø£Ø´Ø¬Ø§Ø±','Ø·Ø­Ù„Ø¨ ÙŠØºØ·ÙŠ','Ø²Ù‚Ø²Ù‚Ø© Ø¹ØµØ§ÙÙŠØ±'],
  'Market':['Ù…Ø³Ø§ÙˆÙ…Ø©','Ø§Ù„ØµØ¨Ø§Ø­ Ø§Ù„Ø¨Ø§ÙƒØ±','Ù…Ø¸Ù„Ø§Øª Ù…Ù„ÙˆÙ†Ø©','Ù†Ù‚Ø¯Ø§Ù‹ ÙÙ‚Ø·'],
  'Lab':['Ù†Ø¸Ø§Ø±Ø§Øª ÙˆØ§Ù‚ÙŠØ©','Ù…ÙˆÙ‚Ø¯ Ø¨Ù†Ø³Ù†','ÙØ±Ø¶ÙŠØ©','Ø¯Ø´ Ø£Ù…Ø§Ù†'],
  'Courtroom':['Ù…Ø­ÙƒÙ…Ø© Ù‚Ø§Ø¦Ù…Ø©','Ø£Ù‚Ø³Ù…','Ø§Ø¹ØªØ±Ø§Ø¶','Ù…Ø¯Ø§ÙˆÙ„Ø©'],
  'Hotel':['Ø®Ø¯Ù…Ø© Ø§Ù„ØºØ±Ù','Ù…ÙŠÙ†ÙŠ Ø¨Ø§Ø±','Ù…ÙƒØ§Ù„Ù…Ø© Ø¥ÙŠÙ‚Ø§Ø¸','ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬'],
  'Stadium':['Ù…ÙˆØ¬Ø© Ø§Ù„Ø¬Ù…Ù‡ÙˆØ±','Ø§Ø³ØªØ±Ø§Ø­Ø© Ù†ØµÙ Ø§Ù„ÙˆÙ‚Øª','Ù…Ù‚Ø§Ø¹Ø¯ Ø¨Ø¹ÙŠØ¯Ø©','Ø§Ø´ØªØ±Ø§Ùƒ Ù…ÙˆØ³Ù…ÙŠ'],
  'Cemetery':['Ø³ÙŠØ§Ø¬ Ø­Ø¯ÙŠØ¯ÙŠ','ØµÙÙˆÙ Ù‡Ø§Ø¯Ø¦Ø©','Ø¨ØªÙ„Ø§Øª Ø°Ø§Ø¨Ù„Ø©','ØªÙˆØ§Ø±ÙŠØ® Ù‚Ø¯ÙŠÙ…Ø©'],
  'Lighthouse':['ØµÙØ§Ø±Ø© Ø¶Ø¨Ø§Ø¨','Ø¯Ø±Ø¬ Ù„ÙˆÙ„Ø¨ÙŠ','Ø´Ø§Ø·Ø¦ ØµØ®Ø±ÙŠ','Ø­Ø§Ø±Ø³'],
  'Bunker':['Ø¬Ø¯Ø±Ø§Ù† Ø³Ù…ÙŠÙƒØ©','Ù…Ø¤Ù†','Ø¨Ø§Ø¨ Ù…Ø­ÙƒÙ…','Ù„Ø§ Ø¥Ø´Ø§Ø±Ø©'],
  'Yacht':['Ø¬Ø§Ù†Ø¨ Ø§Ù„Ù…ÙŠÙ†Ø§Ø¡','Ø¯ÙˆØ§Ø± Ø§Ù„Ø¨Ø­Ø±','Ø³Ø·Ø­ Ø®Ø´Ø¨ Ø§Ù„Ù…Ø§Ù‡ÙˆØºÙ†ÙŠ','Ø®Ø· Ø§Ù„Ø£ÙÙ‚'],
  'Train Station':['Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª','Ø§Ù„Ù…Ø­Ø·Ø© Ø§Ù„Ø£Ø®ÙŠØ±Ø©','ØµÙÙŠØ±','Ø±ØµÙŠÙ Ù©'],
  'Nightclub':['Ø£Ø¶ÙˆØ§Ø¡ Ù…ØªÙ‚Ø·Ø¹Ø©','ØµÙˆØª Ø¬Ù‡ÙŠØ±','Ø­Ø¨Ù„ Ù…Ø®Ù…Ù„ÙŠ','Ø§Ù„Ø«Ø§Ù†ÙŠØ© ØµØ¨Ø§Ø­Ø§Ù‹'],
  'Office':['Ø·Ù†ÙŠÙ† ÙÙ„ÙˆØ±Ø³Ù†Øª','Ù…Ø§ÙƒÙŠÙ†Ø© Ù‚Ù‡ÙˆØ©','Ù© Ø¥Ù„Ù‰ Ù¥','ÙƒØ±Ø³ÙŠ Ø¯ÙˆØ§Ø±'],
  'Parking Lot':['Ø®Ø·ÙˆØ· ØµÙØ±Ø§Ø¡','Ù‚Ø³ÙŠÙ…Ø©','Ø£Ø¹Ù…Ø¯Ø© Ø®Ø±Ø³Ø§Ù†ÙŠØ©','Ø§Ù„Ø·Ø§Ø¨Ù‚ Ø¨Ù¢'],
  'Bank':['Ø£Ø±Ø¶ÙŠØ© Ø±Ø®Ø§Ù…','Ø·Ø§Ø¨ÙˆØ± Ø§Ù†ØªØ¸Ø§Ø±','Ø²Ø¬Ø§Ø¬ Ù…Ø¶Ø§Ø¯ Ù„Ù„Ø±ØµØ§Øµ','ØµÙ†Ø¯ÙˆÙ‚ Ø£Ù…Ø§Ù†Ø§Øª'],
  'Restaurant':['Ø­Ø¬Ø²','Ù„ÙˆØ­Ø© Ø§Ù„Ø¹Ø±ÙˆØ¶','Ù…Ù†Ø§Ø¯ÙŠÙ„ Ù‚Ù…Ø§Ø´','Ø¥Ø¶Ø§Ø¡Ø© Ø´Ù…ÙˆØ¹'],
  'Gym':['Ø­ØµØ§Ø¦Ø± Ù…Ø·Ø§Ø·ÙŠØ©','Ø¬Ø¯Ø§Ø± Ù…Ø±Ø§ÙŠØ§','Ø­Ø§Ù…Ù„ Ù…Ù†Ø§Ø´Ù','Ù…Ø´Ø±ÙˆØ¨ Ø¨Ø±ÙˆØªÙŠÙ†'],
  'Farm':['Ø£Ø¹Ù…Ø§Ù„ Ø§Ù„ÙØ¬Ø±','Ø£Ø­Ø°ÙŠØ© Ù…ÙˆØ­Ù„Ø©','Ù…Ø¨Ù†Ù‰ Ø£Ø­Ù…Ø±','Ø¯ÙŠÙƒØ©'],
  'Aquarium':['ÙˆÙ‡Ø¬ Ø£Ø²Ø±Ù‚','Ù†ÙÙ‚ Ø²Ø¬Ø§Ø¬ÙŠ','ÙˆÙ‚Øª Ø§Ù„ØªØºØ°ÙŠØ©','ÙÙ‚Ø§Ø¹Ø§Øª'],
  'Observatory':['Ù„ÙŠÙ„Ø© ØµØ§ÙÙŠØ©','Ø³Ù‚Ù Ø¯ÙˆØ§Ø±','Ø§Ø±ØªÙØ§Ø¹ Ø¹Ø§Ù„Ù','Ø¶ÙˆØ¡ Ø£Ø­Ù…Ø± ÙÙ‚Ø·'],
  'Mall':['Ø³Ø§Ø­Ø© Ø§Ù„Ø·Ø¹Ø§Ù…','ÙˆØ§Ø¬Ù‡Ø§Øª Ø¹Ø±Ø¶','Ø§Ù†Ø¯ÙØ§Ø¹ Ø§Ù„Ø£Ø¹ÙŠØ§Ø¯','ØªØºÙ„ÙŠÙ Ù‡Ø¯Ø§ÙŠØ§'],
  'Spa':['Ù…Ø§Ø¡ Ø¨Ø§Ù„Ø®ÙŠØ§Ø±','Ø¥Ø¶Ø§Ø¡Ø© Ø®Ø§ÙØªØ©','Ø£Ø±ÙˆØ§Ø¨ Ù†Ø§Ø¹Ù…Ø©','Ø­Ø¬Ø§Ø±Ø© Ø³Ø§Ø®Ù†Ø©'],
  // Weapons
  'Knife':['Ø·Ø§ÙˆÙ„Ø© Ø¹Ø´Ø§Ø¡','Ù‚Ø§Ø¨Ù„ Ù„Ù„Ø·ÙŠ','Ø­Ø§ÙØ© Ù…Ø³Ù†Ù†Ø©','Ø¨Ø­Ø¬Ù… Ø§Ù„Ø¬ÙŠØ¨'],
  'Poison':['Ø¹Ø¯ÙŠÙ… Ø§Ù„Ø±Ø§Ø¦Ø­Ø©','Ù‚Ø·Ø±Ø© Ù‚Ø·Ø±Ø©','Ù…Ø°Ø§Ù‚ Ù…Ø±','Ø¨Ø·ÙŠØ¡ Ø§Ù„Ù…ÙØ¹ÙˆÙ„'],
  'Gun':['Ø­Ø§ÙØ¸Ø©','Ø£Ù…Ø§Ù† Ù…Ø¹Ø·Ù„','ÙŠØ¯Ø®Ù†','Ø³Øª Ø­Ø¬Ø±Ø§Øª'],
  'Rope':['Ø£ÙŠØ¯ÙŠ Ø®Ø´Ù†Ø©','Ø¹Ù‚Ø¯Ø© Ø¨Ø­Ù‘Ø§Ø±','ÙŠØªØ¢ÙƒÙ„','Ù…Ø´Ø¯ÙˆØ¯'],
  'Wrench':['Ø­Ø±ÙƒØ© Ø¯ÙˆØ±Ø§Ù†','ØªØ±ÙƒÙŠØ¨ Ø£Ù†Ø§Ø¨ÙŠØ¨','Ø¨Ù‚Ø¹ ØµØ¯Ø£','Ù‚Ø§Ø¨Ù„ Ù„Ù„ØªØ¹Ø¯ÙŠÙ„'],
  'Candlestick':['Ø´Ù…Ø¹ ÙŠÙ‚Ø·Ø±','ÙˆÙ…ÙŠØ¶','Ø­ÙÙ„ Ø¹Ø´Ø§Ø¡','Ø«Ù‚Ù„ Ù†Ø­Ø§Ø³ÙŠ'],
  'Axe':['ØµÙˆØª Ø´Ù‚','Ø±Ù‚Ø§Ø¦Ù‚ Ø®Ø´Ø¨','Ù‚Ø§Ù„Ø¨ ØªÙ‚Ø·ÙŠØ¹','Ø¶Ø±Ø¨Ø© Ø«Ù‚ÙŠÙ„Ø©'],
  'Crowbar':['Ø±Ø§ÙØ¹Ø©','ÙØªØ­ Ø¨Ø§Ù„Ù‚ÙˆØ©','Ø£Ø­Ù…Ø± ØµØ¯Ø¦','Ù†Ù‡Ø§ÙŠØ© Ù…Ù†Ø­Ù†ÙŠØ©'],
  'Scissors':['Ù„Ù„ÙŠØ¯ Ø§Ù„ÙŠØ³Ø±Ù‰','Ø¬Ø±ÙˆØ­ ÙˆØ±Ù‚','ØµÙˆØª Ù‚Øµ','Ø­Ù„Ù‚ØªØ§Ù†'],
  'Hammer':['Ù…Ø³Ø§Ù…ÙŠØ± Ù…Ø¹ÙˆØ¬Ø©','Ù†Ù‡Ø§ÙŠØ© Ù…Ø®Ù„Ø¨','Ø¥ØµØ§Ø¨Ø© Ø¥Ø¨Ù‡Ø§Ù…','Ø­Ø²Ø§Ù… Ø£Ø¯ÙˆØ§Øª'],
  'Syringe':['Ø¬Ø±Ø¹Ø© ØµØºÙŠØ±Ø©','Ù…ÙƒØ¨Ø³','Ø·Ø±Ù Ø­Ø§Ø¯','Ø¹Ù„Ø§Ù…Ø§Øª Ù‚ÙŠØ§Ø³'],
  'Brick':['Ù…Ù„Ø§Ø· Ù…ØªÙØªØª','Ø·ÙŠÙ†ÙŠ','Ø±Ù…ÙŠØ© Ø«Ù‚ÙŠÙ„Ø©','Ø­ÙˆØ§Ù Ø®Ø´Ù†Ø©'],
  'Pipe':['Ù‚Ø¹Ù‚Ø¹Ø©','Ù†Ù‡Ø§ÙŠØ© Ù…Ù„ÙˆÙ„Ø¨Ø©','ØªØ­Øª Ø§Ù„Ø­ÙˆØ¶','Ø±ØµØ§ØµÙŠ'],
  'Crossbow':['Ø´Ø¯ Ø§Ù„ÙˆØªØ±','Ù…Ù†Ø¸Ø§Ø±','Ø·Ù„Ù‚Ø© ØµØ§Ù…ØªØ©','Ø¬Ø¹Ø¨Ø©'],
  'Chainsaw':['Ø­Ø¨Ù„ Ø³Ø­Ø¨','Ø«Ù†Ø§Ø¦ÙŠ Ø§Ù„Ø£Ø´ÙˆØ§Ø·','Ø§Ù‡ØªØ²Ø§Ø²','Ø­Ù…Ø§ÙŠØ© Ø£Ø°Ù†'],
  'Shovel':['ÙÙ‚Ø§Ø¹Ø§Øª ÙŠØ¯','Ø·Ø±Ù Ù…Ø¯Ø¨Ø¨','ØªØ±Ø§Ø¨ Ø·Ø§Ø²Ø¬','Ø­ÙØ±Ø© Ø¹Ù…ÙŠÙ‚Ø©'],
  'Ice Pick':['Ù…Ø¹Ø¯Ø§Øª ØªØ³Ù„Ù‚','Ù†Ù‚Ø·Ø© Ø¶ÙŠÙ‚Ø©','ÙƒØªÙ„Ø© Ø´ÙØ§ÙØ©','Ø´ÙˆÙƒØ© ÙˆØ§Ø­Ø¯Ø©'],
  'Bat':['Ø¶Ø±Ø¨Ø© Ù‚ÙˆÙŠØ©','Ù‚Ø·Ø±Ø§Ù† Ø§Ù„ØµÙ†ÙˆØ¨Ø±','ØµÙˆØª ØªÙƒØ³ÙŠØ±','Ù„ÙˆÙŠØ²ÙÙŠÙ„'],
  'Dagger':['ØºÙ…Ø¯','Ø²Ø®Ø±ÙÙŠ','ÙˆØ§Ù‚ÙŠ Ù…ØªÙ‚Ø§Ø·Ø¹','Ù‚ØªØ§Ù„ Ù‚Ø±ÙŠØ¨'],
  'Grenade':['Ø´Ø¸Ø§ÙŠØ§','Ø¹Ø¯ Ù„Ù„Ø«Ù„Ø§Ø«Ø©','Ø£Ø®Ø¶Ø± Ø²ÙŠØªÙˆÙ†ÙŠ','Ø­Ù„Ù‚Ø© Ø³Ø­Ø¨'],
  'Taser':['ØµÙˆØª Ø·Ù‚Ø·Ù‚Ø©','Ø´ÙˆÙƒØªØ§Ù†','Ø¥Ø®Ø¶Ø§Ø¹','Ø¹Ù„Ø¨Ø© Ø¨Ø·Ø§Ø±ÙŠØ©'],
  'Machete':['Ø£Ø¯ØºØ§Ù„','Ù†ØµÙ„ Ø¹Ø±ÙŠØ¶','Ù…Ù†Ø§Ø® Ø±Ø·Ø¨','ØµØ¯Ø¦'],
  'Mallet':['ÙˆØ¬Ù‡ Ù…Ø³Ø·Ø­','Ù…Ù„Ø¹Ø¨ ÙƒØ±ÙˆÙƒÙŠÙ‡','Ù†Ø³Ø®Ø© Ù…Ø·Ø§Ø·ÙŠØ©','Ù‚ÙˆØ© Ù„Ø·ÙŠÙØ©'],
  'Scalpel':['Ø´ÙØ±Ø© Ø±Ù‚Ù… Ù¡Ù ','ÙŠØ¯ Ø«Ø§Ø¨ØªØ©','ØµÙŠÙ†ÙŠØ© Ù…Ø¹Ù‚Ù…Ø©','Ù‚Ø·Ø¹ Ø¯Ù‚ÙŠÙ‚'],
  'Drill':['Ù…ÙØªØ§Ø­ Ø¸Ø±Ù','Ù„Ù‚Ù…Ø© Ø­Ù„Ø²ÙˆÙ†ÙŠØ©','Ù„Ø§Ø³Ù„ÙƒÙŠ','Ø«Ù‚Ø¨ ØªØ¬Ø±ÙŠØ¨ÙŠ'],
  'Trophy':['Ù„ÙˆØ­Ø© Ù…Ø­ÙÙˆØ±Ø©','Ø±Ù Ø¹Ø±Ø¶','ØªÙ…Ø«Ø§Ù„ Ø°Ù‡Ø¨ÙŠ','Ø§Ù„Ù…Ø±ÙƒØ² Ø§Ù„Ø£ÙˆÙ„'],
  'Frying Pan':['Ø£Ø²ÙŠØ²','Ø¨Ù‚Ø§ÙŠØ§ Ø³ÙˆØ¯Ø§Ø¡','Ù…Ù‚Ø¨Ø¶ Ø³Ø§Ø®Ù†','Ù…ÙØªØ¨Ù‘Ù„'],
  'Whip':['Ù…Ø¶ÙØ±','ØµÙˆØª ÙØ±Ù‚Ø¹Ø©','Ø¬Ù„Ø¯ Ø¨Ù‚Ø±','Ù…Ø¯Ù‰ Ø¨Ø¹ÙŠØ¯'],
  'Pitchfork':['Ø«Ù„Ø§Ø« Ø´ÙˆÙƒØ§Øª','Ø¨Ø§Ù„Ø© Ù‚Ø´','Ø£Ø¯Ø§Ø© Ø­Ø¸ÙŠØ±Ø©','Ø¹Ù…ÙˆØ¯ Ø®Ø´Ø¨ÙŠ'],
  'Hatchet':['Ø­Ù„Ù‚Ø© Ø­Ø²Ø§Ù…','Ø¥Ø´Ø¹Ø§Ù„','Ø¨Ø­Ø¬Ù… Ø§Ù„ÙŠØ¯','ØªÙˆÙ…Ø§Ù‡ÙˆÙƒ'],
  'Spear':['Ø¹Ù…ÙˆØ¯','ÙŠÙØ±Ù…Ù‰ Ø¨Ø¹ÙŠØ¯Ø§Ù‹','Ø±Ø£Ø³ ØµÙˆØ§Ù†','ØµÙŠØ¯ Ù‚Ø¯ÙŠÙ…'],
  'Saw':['Ø§Ø¯ÙØ¹ ÙˆØ§Ø³Ø­Ø¨','Ø£Ø³Ù†Ø§Ù† Ù…Ø³Ù†Ù†Ø©','ØºØ¨Ø§Ø± Ù†Ø§Ø¹Ù…','Ù‚Ø·Ø¹ Ù…Ø³ØªÙ‚ÙŠÙ…'],
  'Torch':['ÙˆÙ…ÙŠØ¶','Ù‚Ù…Ø§Ø´ Ù…Ù„ÙÙˆÙ','Ù…Ø³ÙŠØ±Ø© Ù„ÙŠÙ„ÙŠØ©','Ø±Ø§ØªÙ†Ø¬ ØµÙ†ÙˆØ¨Ø±'],
  'Bolt Cutter':['ÙÙƒÙˆÙƒ Ù‚Ø§Ø·Ø¹Ø©','Ù‚ÙÙ„','Ù…Ù‚Ø§Ø¨Ø¶ Ø·ÙˆÙŠÙ„Ø©','ÙÙˆÙ„Ø§Ø° Ù…Ù‚Ø³Ù‘Ù‰'],
  'Chain':['Ø®Ø´Ø®Ø´Ø©','Ø­Ù„Ù‚Ø§Øª Ù…ØªØµÙ„Ø©','Ø®Ø· Ù…Ø±Ø³Ø§Ø©','Ù…Ø¹Ø¯Ù† Ø¨Ø§Ø±Ø¯'],
  'Stiletto':['Ø±ÙÙŠØ¹ ÙƒØ§Ù„Ø¥Ø¨Ø±Ø©','Ø²Ù†Ø¨Ø±ÙƒÙŠ','ØµÙ†Ø§Ø¹Ø© Ø¥ÙŠØ·Ø§Ù„ÙŠØ©','Ù…Ø®ÙÙŠ'],
  'Blowdart':['Ù‚ØµØ¨Ø© Ù…Ø¬ÙˆÙØ©','Ù‚ÙˆØ© Ø±Ø¦Ø©','Ù…Ù‚Ø°ÙˆÙ ØµØºÙŠØ±','Ø£Ø¯ØºØ§Ù„'],
  'Garrote':['Ø³Ù„Ùƒ Ø¨ÙŠØ§Ù†Ùˆ','Ù…Ù† Ø§Ù„Ø®Ù„Ù','Ø®Ø· Ø±ÙÙŠØ¹','ØµØ§Ù…Øª'],
  'Flare Gun':['Ø³Ù…Ø§Ø¡ Ø­Ù…Ø±Ø§Ø¡','Ø§Ø³ØªØºØ§Ø«Ø©','Ø·Ù„Ù‚Ø© ÙˆØ§Ø­Ø¯Ø©','Ù‚ÙˆØ³ Ù…Ø´ØªØ¹Ù„'],
  'Sledgehammer':['Ù‚Ø¨Ø¶Ø© Ø¨ÙŠØ¯ÙŠÙ†','ØºØ¨Ø§Ø± Ø®Ø±Ø³Ø§Ù†Ø©','Ø£Ø±Ø¬Ø­Ø© ÙƒØ§Ù…Ù„Ø©','Ù¡Ù  Ø£Ø±Ø·Ø§Ù„']
};

function tWord(w) { return currentLang === 'ar' ? (WORDS_AR[w] || w) : w; }

// ======================== TRANSLATIONS ========================
let currentLang = localStorage.getItem('det-lang') || 'en';

const TR = {
en: {
  title:'DETECTIVES', createGame:'Create Game', joinGame:'Join Game', howToPlay:'How to Play', back:'Back',
  createTitle:'Create Game', createSub:"You'll be the host", namePH:'Your name...', createRoom:'Create Room',
  joinTitle:'Join Game', joinSub:'Enter the room code', codePH:'Room code (4 letters)', joinRoom:'Join Room',
  roomCode:'Room Code', shareCode:'Share Code', playersOf:'Players', gameSettings:'\u2699\uFE0F Game Settings',
  startGame:'Start Game', waitHost:'Waiting for host to start', leaveGame:'Leave Game',
  sMinP:'Min Players', sMinPd:'Minimum to start', sMaxP:'Max Players', sMaxPd:'Room capacity',
  sSus:'Suspects', sSusd:'Auto scales with players', sGrid:'Grid Size', sGridd:'Words per grid',
  sPrep:'Prep Time', sPrepd:'Silent reading phase', sDisc:'Discussion Time', sDiscd:'Team discussion phase',
  sJudge:'Judge Time', sJudged:'Decision timer', auto:'Auto',
  yourRole:'Your Secret Role', tapReveal:'Tap to Reveal', ready:"I'm Ready", waitOthers:'Waiting for others',
  waitPlayers:'Waiting for Players', everyoneConfirm:'Everyone needs to confirm their role...',
  Judge:'Judge', Witness:'Witness', Detective:'Detective', Suspect:'Suspect',
  judgeDesc:'You have no information.<br>Listen to discussions and make the final call.',
  witnessDesc:"Guide your team subtly. Don't get exposed!",
  detectiveDesc:"You'll receive clues each round.<br>Share and deduce with your team!",
  suspectDesc:'You know the answers. Pretend to be a Detective and mislead everyone!',
  judgeInfo:'\u2696\uFE0F You are the Judge \u2014 Listen and decide',
  theWord:'The', locLabel:'Location', weapLabel:'Weapon', is:'is:',
  clue:'Your clue:', knowAnswer:'You know the answer:',
  s1Loc:'\uD83D\uDCCD Stage 1 \u2014 Location', s2Weap:'\uD83D\uDD2A Stage 2 \u2014 Weapon',
  s3Sus:'\uD83D\uDD34 Stage 3 \u2014 Suspect',
  readLoc:'Read the Location Grid', readWeap:'Read the Weapon Grid',
  locDisc:'Location Discussion', weapDisc:'Weapon Discussion',
  PREP:'PREPARATION', DISC:'DISCUSSION',
  discHint:'Discuss openly. Detectives share clues. Suspects bluff!',
  prepHint:'Read the words silently. Prepare your strategy.',
  endDiscEarly:'End Discussion Early',
  pickLoc:'Pick the Location', pickWeap:'Pick the Weapon', idSuspect:'Identify the Suspect',
  makeChoice:'Make your choice', locPick:'Location Pick', weapPick:'Weapon Pick',
  susId:'Suspect Identification', judgeChoosing:'Judge is choosing...',
  decideOrLose:'DECIDE OR SUSPECTS WIN', waitJudge:"Waiting for Judge's decision",
  confirmSel:'Confirm Selection',
  correct:'Correct!', wrong:'Wrong!', judgePicked:'The Judge picked:', correctAns:'Correct answer:',
  nextStage:'Next Stage', continuing:'Continuing',
  susTurn:'\uD83D\uDD34 Suspect\'s Turn', whoWitness:'Who is the Witness?',
  pickWitness:'Pick the player you think is the Witness',
  confirmGuess:'Confirm Guess', voteSubmitted:'Vote Submitted', susVoting:'Suspects are voting',
  susGuessing:'The suspects are now guessing who the Witness is...',
  teamWins:'Team Wins!', teamWinsD:'Both words were correct and the Witness stayed hidden!',
  susWin:'Suspects Win!',
  judgeTO:'Judge ran out of time! ', wrongLoc:'Wrong location. ', wrongWeap:'Wrong weapon. ',
  witExposed:'Witness was exposed! ',
  resultsLabel:'Results:', notReached:'Not reached', witExpLabel:'Witness exposed:',
  yesW:'Yes', noW:'No', susGuessLabel:'Suspect guess:', playAgain:'Play Again',
  disconnected:'Disconnected', connLost:'Connection lost.', backMenu:'Back to Menu',
  enterName:'Enter your name', creatingRoom:'Creating room...', roomCreated:'Room created!',
  connectingDots:'Connecting...', enterCode:'Enter a 4-letter room code',
  roomNotFound:'Room not found. Check the code.', cantConnect:'Could not connect. Check the room code.',
  connErr:'Connection error: ', roomFull:'Room is full', nameTaken:'Name already taken',
  xJoined:' joined', xDisc:' disconnected',
  hostDC:'Host disconnected. The game has ended.', hostLost:'Connection to host lost.',
  codeCopied:'Code copied!',
  need:'Need at least', toStart:'players to start', pPlayers:'players',
  langBtn:'\u0639\u0631\u0628\u064A',
  // Rules
  rSetup:'<b style="color:var(--gold)">Setup:</b> One player creates a game and shares the 4-letter room code. Everyone else joins on their own device.',
  rRoles:'<b style="color:var(--text)">Roles are dealt secretly:</b>',
  rJudge:'\u2696\uFE0F <b>Judge</b> \u2014 No info. Runs the investigation. Makes the final call on every vote.',
  rWitness:'\uD83D\uDC41\uFE0F <b>Witness</b> \u2014 Knows the crime location and murder weapon. Must guide the team without being obvious.',
  rDetective:'\uD83D\uDD0D <b>Detective</b> \u2014 Gets one subtle clue per round. Shares it aloud and helps the Judge piece things together.',
  rSuspect:'\uD83D\uDD34 <b>Suspect</b> \u2014 Also knows the location and weapon. Pretends to be a Detective and tries to mislead everyone.',
  rR1:'<b style="color:var(--blue)">Round 1 \u2014 Location:</b> A grid of locations appears. Everyone reads silently, then discusses openly. Detectives share clues, Suspects bluff. The Judge picks the crime scene.',
  rR2:'<b style="color:var(--red)">Round 2 \u2014 Weapon:</b> A new grid of weapons. Same flow \u2014 clues, discussion, Judge decides. A wrong pick ends the game immediately.',
  rR3:'<b style="color:var(--purple)">Round 3 \u2014 Whodunit:</b> The Judge picks who they think the Suspect is. Then each Suspect secretly guesses who the Witness is.',
  rTeamW:'<b style="color:var(--green)">Team Wins:</b> Judge gets both words right AND the Witness stays hidden.',
  rSusW:'<b style="color:var(--red)">Suspects Win:</b> Judge picks a wrong word OR a Suspect correctly identifies the Witness.',
  guessed:' guessed ',
  loc:'Location', weap:'Weapon',
  localWifi:'Local WiFi', localWifiSub:'Everyone on the same network',
},
ar: {
  title:'\u0627\u0644\u0645\u062D\u0642\u0642\u0648\u0646',
  createGame:'\u0625\u0646\u0634\u0627\u0621 \u0644\u0639\u0628\u0629',
  joinGame:'\u0627\u0646\u0636\u0645\u0627\u0645 \u0644\u0644\u0639\u0628\u0629',
  howToPlay:'\u0637\u0631\u064A\u0642\u0629 \u0627\u0644\u0644\u0639\u0628',
  back:'\u0631\u062C\u0648\u0639',
  createTitle:'\u0625\u0646\u0634\u0627\u0621 \u0644\u0639\u0628\u0629',
  createSub:'\u0633\u062A\u0643\u0648\u0646 \u0623\u0646\u062A \u0627\u0644\u0645\u0636\u064A\u0641',
  namePH:'\u0627\u0633\u0645\u0643...',
  createRoom:'\u0625\u0646\u0634\u0627\u0621 \u063A\u0631\u0641\u0629',
  joinTitle:'\u0627\u0646\u0636\u0645\u0627\u0645 \u0644\u0644\u0639\u0628\u0629',
  joinSub:'\u0623\u062F\u062E\u0644 \u0631\u0645\u0632 \u0627\u0644\u063A\u0631\u0641\u0629',
  codePH:'\u0631\u0645\u0632 \u0627\u0644\u063A\u0631\u0641\u0629 (4 \u0623\u062D\u0631\u0641)',
  joinRoom:'\u0627\u0646\u0636\u0645\u0627\u0645',
  roomCode:'\u0631\u0645\u0632 \u0627\u0644\u063A\u0631\u0641\u0629',
  shareCode:'\u0645\u0634\u0627\u0631\u0643\u0629 \u0627\u0644\u0631\u0645\u0632',
  playersOf:'\u0627\u0644\u0644\u0627\u0639\u0628\u0648\u0646',
  gameSettings:'\u2699\uFE0F \u0625\u0639\u062F\u0627\u062F\u0627\u062A \u0627\u0644\u0644\u0639\u0628\u0629',
  startGame:'\u0628\u062F\u0621 \u0627\u0644\u0644\u0639\u0628\u0629',
  waitHost:'\u0628\u0627\u0646\u062A\u0638\u0627\u0631 \u0627\u0644\u0645\u0636\u064A\u0641 \u0644\u0628\u062F\u0621 \u0627\u0644\u0644\u0639\u0628\u0629',
  leaveGame:'\u0645\u063A\u0627\u062F\u0631\u0629 \u0627\u0644\u0644\u0639\u0628\u0629',
  sMinP:'\u0623\u0642\u0644 \u0639\u062F\u062F \u0644\u0627\u0639\u0628\u064A\u0646',
  sMinPd:'\u0627\u0644\u062D\u062F \u0627\u0644\u0623\u062F\u0646\u0649 \u0644\u0644\u0628\u062F\u0621',
  sMaxP:'\u0623\u0643\u062B\u0631 \u0639\u062F\u062F \u0644\u0627\u0639\u0628\u064A\u0646',
  sMaxPd:'\u0633\u0639\u0629 \u0627\u0644\u063A\u0631\u0641\u0629',
  sSus:'\u0627\u0644\u0645\u0634\u062A\u0628\u0647 \u0628\u0647\u0645',
  sSusd:'\u064A\u062A\u063A\u064A\u0631 \u062A\u0644\u0642\u0627\u0626\u064A\u0627\u064B \u062D\u0633\u0628 \u0639\u062F\u062F \u0627\u0644\u0644\u0627\u0639\u0628\u064A\u0646',
  sGrid:'\u062D\u062C\u0645 \u0627\u0644\u0634\u0628\u0643\u0629',
  sGridd:'\u0639\u062F\u062F \u0627\u0644\u0643\u0644\u0645\u0627\u062A',
  sPrep:'\u0648\u0642\u062A \u0627\u0644\u062A\u062D\u0636\u064A\u0631',
  sPrepd:'\u0645\u0631\u062D\u0644\u0629 \u0627\u0644\u0642\u0631\u0627\u0621\u0629 \u0627\u0644\u0635\u0627\u0645\u062A\u0629',
  sDisc:'\u0648\u0642\u062A \u0627\u0644\u0646\u0642\u0627\u0634',
  sDiscd:'\u0645\u0631\u062D\u0644\u0629 \u0627\u0644\u0646\u0642\u0627\u0634 \u0627\u0644\u062C\u0645\u0627\u0639\u064A',
  sJudge:'\u0648\u0642\u062A \u0627\u0644\u0642\u0627\u0636\u064A',
  sJudged:'\u0645\u0624\u0642\u062A \u0627\u0644\u0642\u0631\u0627\u0631',
  auto:'\u062A\u0644\u0642\u0627\u0626\u064A',
  yourRole:'\u062F\u0648\u0631\u0643 \u0627\u0644\u0633\u0631\u064A',
  tapReveal:'\u0627\u0636\u063A\u0637 \u0644\u0644\u0643\u0634\u0641',
  ready:'\u0623\u0646\u0627 \u062C\u0627\u0647\u0632',
  waitOthers:'\u0628\u0627\u0646\u062A\u0638\u0627\u0631 \u0627\u0644\u0622\u062E\u0631\u064A\u0646',
  waitPlayers:'\u0628\u0627\u0646\u062A\u0638\u0627\u0631 \u0627\u0644\u0644\u0627\u0639\u0628\u064A\u0646',
  everyoneConfirm:'\u064A\u062C\u0628 \u0623\u0646 \u064A\u0624\u0643\u062F \u0627\u0644\u062C\u0645\u064A\u0639 \u0623\u062F\u0648\u0627\u0631\u0647\u0645...',
  Judge:'\u0627\u0644\u0642\u0627\u0636\u064A',
  Witness:'\u0627\u0644\u0634\u0627\u0647\u062F',
  Detective:'\u0627\u0644\u0645\u062D\u0642\u0642',
  Suspect:'\u0627\u0644\u0645\u0634\u062A\u0628\u0647 \u0628\u0647',
  judgeDesc:'\u0644\u0627 \u062A\u0645\u0644\u0643 \u0623\u064A \u0645\u0639\u0644\u0648\u0645\u0627\u062A.<br>\u0627\u0633\u062A\u0645\u0639 \u0644\u0644\u0646\u0642\u0627\u0634 \u0648\u0627\u062A\u062E\u0630 \u0627\u0644\u0642\u0631\u0627\u0631 \u0627\u0644\u0646\u0647\u0627\u0626\u064A.',
  witnessDesc:'\u0633\u0627\u0639\u062F \u0641\u0631\u064A\u0642\u0643 \u0628\u0630\u0643\u0627\u0621. \u0644\u0627 \u062A\u0643\u0634\u0641 \u0647\u0648\u064A\u062A\u0643!',
  detectiveDesc:'\u0633\u062A\u062D\u0635\u0644 \u0639\u0644\u0649 \u062F\u0644\u0627\u0626\u0644 \u0641\u064A \u0643\u0644 \u062C\u0648\u0644\u0629.<br>\u0634\u0627\u0631\u0643\u0647\u0627 \u0648\u0633\u0627\u0639\u062F \u0627\u0644\u0641\u0631\u064A\u0642!',
  suspectDesc:'\u0623\u0646\u062A \u062A\u0639\u0631\u0641 \u0627\u0644\u0625\u062C\u0627\u0628\u0627\u062A. \u062A\u0638\u0627\u0647\u0631 \u0628\u0623\u0646\u0643 \u0645\u062D\u0642\u0642 \u0648\u0636\u0644\u0651\u0644 \u0627\u0644\u062C\u0645\u064A\u0639!',
  judgeInfo:'\u2696\uFE0F \u0623\u0646\u062A \u0627\u0644\u0642\u0627\u0636\u064A \u2014 \u0627\u0633\u062A\u0645\u0639 \u0648\u0642\u0631\u0631',
  theWord:'', locLabel:'\u0627\u0644\u0645\u0648\u0642\u0639', weapLabel:'\u0627\u0644\u0633\u0644\u0627\u062D', is:'\u0647\u0648:',
  clue:'\u062F\u0644\u064A\u0644\u0643:', knowAnswer:'\u0623\u0646\u062A \u062A\u0639\u0631\u0641 \u0627\u0644\u0625\u062C\u0627\u0628\u0629:',
  s1Loc:'\uD83D\uDCCD \u0627\u0644\u062C\u0648\u0644\u0629 \u0661 \u2014 \u0627\u0644\u0645\u0648\u0642\u0639',
  s2Weap:'\uD83D\uDD2A \u0627\u0644\u062C\u0648\u0644\u0629 \u0662 \u2014 \u0627\u0644\u0633\u0644\u0627\u062D',
  s3Sus:'\uD83D\uDD34 \u0627\u0644\u062C\u0648\u0644\u0629 \u0663 \u2014 \u0627\u0644\u0645\u0634\u062A\u0628\u0647 \u0628\u0647',
  readLoc:'\u0627\u0642\u0631\u0623 \u0634\u0628\u0643\u0629 \u0627\u0644\u0645\u0648\u0627\u0642\u0639',
  readWeap:'\u0627\u0642\u0631\u0623 \u0634\u0628\u0643\u0629 \u0627\u0644\u0623\u0633\u0644\u062D\u0629',
  locDisc:'\u0646\u0642\u0627\u0634 \u0627\u0644\u0645\u0648\u0642\u0639',
  weapDisc:'\u0646\u0642\u0627\u0634 \u0627\u0644\u0633\u0644\u0627\u062D',
  PREP:'\u0627\u0644\u062A\u062D\u0636\u064A\u0631',
  DISC:'\u0627\u0644\u0646\u0642\u0627\u0634',
  discHint:'\u0646\u0627\u0642\u0634\u0648\u0627 \u0628\u0635\u0648\u062A \u0639\u0627\u0644\u064D. \u0627\u0644\u0645\u062D\u0642\u0642\u0648\u0646 \u064A\u0634\u0627\u0631\u0643\u0648\u0646 \u0627\u0644\u062F\u0644\u0627\u0626\u0644. \u0627\u0644\u0645\u0634\u062A\u0628\u0647 \u0628\u0647\u0645 \u064A\u0636\u0644\u0644\u0648\u0646!',
  prepHint:'\u0627\u0642\u0631\u0623 \u0627\u0644\u0643\u0644\u0645\u0627\u062A \u0628\u0635\u0645\u062A. \u062D\u0636\u0651\u0631 \u0627\u0633\u062A\u0631\u0627\u062A\u064A\u062C\u064A\u062A\u0643.',
  endDiscEarly:'\u0625\u0646\u0647\u0627\u0621 \u0627\u0644\u0646\u0642\u0627\u0634 \u0645\u0628\u0643\u0631\u0627\u064B',
  pickLoc:'\u0627\u062E\u062A\u0631 \u0627\u0644\u0645\u0648\u0642\u0639',
  pickWeap:'\u0627\u062E\u062A\u0631 \u0627\u0644\u0633\u0644\u0627\u062D',
  idSuspect:'\u062D\u062F\u062F \u0627\u0644\u0645\u0634\u062A\u0628\u0647 \u0628\u0647',
  makeChoice:'\u0627\u062A\u062E\u0630 \u0642\u0631\u0627\u0631\u0643',
  locPick:'\u0627\u062E\u062A\u064A\u0627\u0631 \u0627\u0644\u0645\u0648\u0642\u0639',
  weapPick:'\u0627\u062E\u062A\u064A\u0627\u0631 \u0627\u0644\u0633\u0644\u0627\u062D',
  susId:'\u062A\u062D\u062F\u064A\u062F \u0627\u0644\u0645\u0634\u062A\u0628\u0647 \u0628\u0647',
  judgeChoosing:'\u0627\u0644\u0642\u0627\u0636\u064A \u064A\u062E\u062A\u0627\u0631...',
  decideOrLose:'\u0642\u0631\u0631 \u0648\u0625\u0644\u0627 \u064A\u0641\u0648\u0632 \u0627\u0644\u0645\u0634\u062A\u0628\u0647 \u0628\u0647\u0645',
  waitJudge:'\u0628\u0627\u0646\u062A\u0638\u0627\u0631 \u0642\u0631\u0627\u0631 \u0627\u0644\u0642\u0627\u0636\u064A',
  confirmSel:'\u062A\u0623\u0643\u064A\u062F \u0627\u0644\u0627\u062E\u062A\u064A\u0627\u0631',
  correct:'\u0635\u062D\u064A\u062D!',
  wrong:'\u062E\u0637\u0623!',
  judgePicked:'\u0627\u0644\u0642\u0627\u0636\u064A \u0627\u062E\u062A\u0627\u0631:',
  correctAns:'\u0627\u0644\u0625\u062C\u0627\u0628\u0629 \u0627\u0644\u0635\u062D\u064A\u062D\u0629:',
  nextStage:'\u0627\u0644\u062C\u0648\u0644\u0629 \u0627\u0644\u062A\u0627\u0644\u064A\u0629',
  continuing:'\u062C\u0627\u0631\u064D \u0627\u0644\u0645\u062A\u0627\u0628\u0639\u0629',
  susTurn:'\uD83D\uDD34 \u062F\u0648\u0631 \u0627\u0644\u0645\u0634\u062A\u0628\u0647 \u0628\u0647\u0645',
  whoWitness:'\u0645\u0646 \u0647\u0648 \u0627\u0644\u0634\u0627\u0647\u062F\u061F',
  pickWitness:'\u0627\u062E\u062A\u0631 \u0627\u0644\u0644\u0627\u0639\u0628 \u0627\u0644\u0630\u064A \u062A\u0639\u062A\u0642\u062F \u0623\u0646\u0647 \u0627\u0644\u0634\u0627\u0647\u062F',
  confirmGuess:'\u062A\u0623\u0643\u064A\u062F \u0627\u0644\u062A\u062E\u0645\u064A\u0646',
  voteSubmitted:'\u062A\u0645 \u0627\u0644\u062A\u0635\u0648\u064A\u062A',
  susVoting:'\u0627\u0644\u0645\u0634\u062A\u0628\u0647 \u0628\u0647\u0645 \u064A\u0635\u0648\u062A\u0648\u0646',
  susGuessing:'\u0627\u0644\u0645\u0634\u062A\u0628\u0647 \u0628\u0647\u0645 \u064A\u062D\u0627\u0648\u0644\u0648\u0646 \u062A\u062E\u0645\u064A\u0646 \u0647\u0648\u064A\u0629 \u0627\u0644\u0634\u0627\u0647\u062F...',
  teamWins:'\u0627\u0644\u0641\u0631\u064A\u0642 \u064A\u0641\u0648\u0632!',
  teamWinsD:'\u062A\u0645 \u062A\u062E\u0645\u064A\u0646 \u0627\u0644\u0643\u0644\u0645\u062A\u064A\u0646 \u0628\u0634\u0643\u0644 \u0635\u062D\u064A\u062D \u0648\u0627\u0644\u0634\u0627\u0647\u062F \u0644\u0645 \u064A\u064F\u0643\u0634\u0641!',
  susWin:'\u0627\u0644\u0645\u0634\u062A\u0628\u0647 \u0628\u0647\u0645 \u064A\u0641\u0648\u0632\u0648\u0646!',
  judgeTO:'\u0646\u0641\u062F \u0648\u0642\u062A \u0627\u0644\u0642\u0627\u0636\u064A! ',
  wrongLoc:'\u0645\u0648\u0642\u0639 \u062E\u0627\u0637\u0626. ',
  wrongWeap:'\u0633\u0644\u0627\u062D \u062E\u0627\u0637\u0626. ',
  witExposed:'\u062A\u0645 \u0643\u0634\u0641 \u0627\u0644\u0634\u0627\u0647\u062F! ',
  resultsLabel:'\u0627\u0644\u0646\u062A\u0627\u0626\u062C:',
  notReached:'\u0644\u0645 \u064A\u062A\u0645 \u0627\u0644\u0648\u0635\u0648\u0644',
  witExpLabel:'\u0627\u0646\u0643\u0634\u0627\u0641 \u0627\u0644\u0634\u0627\u0647\u062F:',
  yesW:'\u0646\u0639\u0645', noW:'\u0644\u0627',
  susGuessLabel:'\u062A\u062E\u0645\u064A\u0646 \u0627\u0644\u0645\u0634\u062A\u0628\u0647 \u0628\u0647:',
  playAgain:'\u0644\u0639\u0628 \u0645\u0631\u0629 \u0623\u062E\u0631\u0649',
  disconnected:'\u0627\u0646\u0642\u0637\u0639 \u0627\u0644\u0627\u062A\u0635\u0627\u0644',
  connLost:'\u0641\u064F\u0642\u062F \u0627\u0644\u0627\u062A\u0635\u0627\u0644.',
  backMenu:'\u0627\u0644\u0639\u0648\u062F\u0629 \u0644\u0644\u0642\u0627\u0626\u0645\u0629',
  enterName:'\u0623\u062F\u062E\u0644 \u0627\u0633\u0645\u0643',
  creatingRoom:'\u062C\u0627\u0631\u064D \u0625\u0646\u0634\u0627\u0621 \u0627\u0644\u063A\u0631\u0641\u0629...',
  roomCreated:'\u062A\u0645 \u0625\u0646\u0634\u0627\u0621 \u0627\u0644\u063A\u0631\u0641\u0629!',
  connectingDots:'\u062C\u0627\u0631\u064D \u0627\u0644\u0627\u062A\u0635\u0627\u0644...',
  enterCode:'\u0623\u062F\u062E\u0644 \u0631\u0645\u0632 \u0627\u0644\u063A\u0631\u0641\u0629 (4 \u0623\u062D\u0631\u0641)',
  roomNotFound:'\u0627\u0644\u063A\u0631\u0641\u0629 \u063A\u064A\u0631 \u0645\u0648\u062C\u0648\u062F\u0629. \u062A\u062D\u0642\u0642 \u0645\u0646 \u0627\u0644\u0631\u0645\u0632.',
  cantConnect:'\u062A\u0639\u0630\u0631 \u0627\u0644\u0627\u062A\u0635\u0627\u0644. \u062A\u062D\u0642\u0642 \u0645\u0646 \u0631\u0645\u0632 \u0627\u0644\u063A\u0631\u0641\u0629.',
  connErr:'\u062E\u0637\u0623 \u0641\u064A \u0627\u0644\u0627\u062A\u0635\u0627\u0644: ',
  roomFull:'\u0627\u0644\u063A\u0631\u0641\u0629 \u0645\u0645\u062A\u0644\u0626\u0629',
  nameTaken:'\u0627\u0644\u0627\u0633\u0645 \u0645\u0633\u062A\u062E\u062F\u0645 \u0628\u0627\u0644\u0641\u0639\u0644',
  xJoined:' \u0627\u0646\u0636\u0645',
  xDisc:' \u0627\u0646\u0642\u0637\u0639 \u0627\u062A\u0635\u0627\u0644\u0647',
  hostDC:'\u0627\u0646\u0642\u0637\u0639 \u0627\u062A\u0635\u0627\u0644 \u0627\u0644\u0645\u0636\u064A\u0641. \u0627\u0646\u062A\u0647\u062A \u0627\u0644\u0644\u0639\u0628\u0629.',
  hostLost:'\u0641\u064F\u0642\u062F \u0627\u0644\u0627\u062A\u0635\u0627\u0644 \u0628\u0627\u0644\u0645\u0636\u064A\u0641.',
  codeCopied:'\u062A\u0645 \u0646\u0633\u062E \u0627\u0644\u0631\u0645\u0632!',
  need:'\u064A\u0644\u0632\u0645 \u0639\u0644\u0649 \u0627\u0644\u0623\u0642\u0644',
  toStart:'\u0644\u0627\u0639\u0628\u064A\u0646 \u0644\u0644\u0628\u062F\u0621',
  pPlayers:'\u0644\u0627\u0639\u0628\u064A\u0646',
  langBtn:'EN',
  rSetup:'<b style="color:var(--gold)">\u0627\u0644\u0625\u0639\u062F\u0627\u062F:</b> \u0644\u0627\u0639\u0628 \u0648\u0627\u062D\u062F \u064A\u0646\u0634\u0626 \u0627\u0644\u0644\u0639\u0628\u0629 \u0648\u064A\u0634\u0627\u0631\u0643 \u0631\u0645\u0632 \u0627\u0644\u063A\u0631\u0641\u0629. \u0627\u0644\u0628\u0642\u064A\u0629 \u064A\u0646\u0636\u0645\u0648\u0646 \u0645\u0646 \u0623\u062C\u0647\u0632\u062A\u0647\u0645.',
  rRoles:'<b style="color:var(--text)">\u0627\u0644\u0623\u062F\u0648\u0627\u0631 \u062A\u0648\u0632\u0639 \u0633\u0631\u0627\u064B:</b>',
  rJudge:'\u2696\uFE0F <b>\u0627\u0644\u0642\u0627\u0636\u064A</b> \u2014 \u0644\u0627 \u064A\u0645\u0644\u0643 \u0645\u0639\u0644\u0648\u0645\u0627\u062A. \u064A\u062F\u064A\u0631 \u0627\u0644\u062A\u062D\u0642\u064A\u0642 \u0648\u064A\u062A\u062E\u0630 \u0627\u0644\u0642\u0631\u0627\u0631 \u0627\u0644\u0646\u0647\u0627\u0626\u064A.',
  rWitness:'\uD83D\uDC41\uFE0F <b>\u0627\u0644\u0634\u0627\u0647\u062F</b> \u2014 \u064A\u0639\u0631\u0641 \u0645\u0648\u0642\u0639 \u0627\u0644\u062C\u0631\u064A\u0645\u0629 \u0648\u0633\u0644\u0627\u062D \u0627\u0644\u0642\u062A\u0644. \u064A\u062C\u0628 \u0623\u0646 \u064A\u0633\u0627\u0639\u062F \u0627\u0644\u0641\u0631\u064A\u0642 \u0628\u062F\u0648\u0646 \u0623\u0646 \u064A\u0643\u0648\u0646 \u0648\u0627\u0636\u062D\u0627\u064B.',
  rDetective:'\uD83D\uDD0D <b>\u0627\u0644\u0645\u062D\u0642\u0642</b> \u2014 \u064A\u062D\u0635\u0644 \u0639\u0644\u0649 \u062F\u0644\u064A\u0644 \u062E\u0641\u064A \u0641\u064A \u0643\u0644 \u062C\u0648\u0644\u0629. \u064A\u0634\u0627\u0631\u0643\u0647 \u0628\u0635\u0648\u062A \u0639\u0627\u0644\u064D \u0648\u064A\u0633\u0627\u0639\u062F \u0627\u0644\u0642\u0627\u0636\u064A.',
  rSuspect:'\uD83D\uDD34 <b>\u0627\u0644\u0645\u0634\u062A\u0628\u0647 \u0628\u0647</b> \u2014 \u064A\u0639\u0631\u0641 \u0623\u064A\u0636\u0627\u064B \u0627\u0644\u0645\u0648\u0642\u0639 \u0648\u0627\u0644\u0633\u0644\u0627\u062D. \u064A\u062A\u0638\u0627\u0647\u0631 \u0628\u0623\u0646\u0647 \u0645\u062D\u0642\u0642 \u0648\u064A\u062D\u0627\u0648\u0644 \u062A\u0636\u0644\u064A\u0644 \u0627\u0644\u062C\u0645\u064A\u0639.',
  rR1:'<b style="color:var(--blue)">\u0627\u0644\u062C\u0648\u0644\u0629 \u0661 \u2014 \u0627\u0644\u0645\u0648\u0642\u0639:</b> \u062A\u0638\u0647\u0631 \u0634\u0628\u0643\u0629 \u0645\u0648\u0627\u0642\u0639. \u0627\u0644\u062C\u0645\u064A\u0639 \u064A\u0642\u0631\u0623 \u0628\u0635\u0645\u062A \u062B\u0645 \u064A\u0646\u0627\u0642\u0634. \u0627\u0644\u0645\u062D\u0642\u0642\u0648\u0646 \u064A\u0634\u0627\u0631\u0643\u0648\u0646 \u0627\u0644\u062F\u0644\u0627\u0626\u0644 \u0648\u0627\u0644\u0645\u0634\u062A\u0628\u0647 \u0628\u0647\u0645 \u064A\u0636\u0644\u0644\u0648\u0646. \u0627\u0644\u0642\u0627\u0636\u064A \u064A\u062E\u062A\u0627\u0631 \u0645\u0643\u0627\u0646 \u0627\u0644\u062C\u0631\u064A\u0645\u0629.',
  rR2:'<b style="color:var(--red)">\u0627\u0644\u062C\u0648\u0644\u0629 \u0662 \u2014 \u0627\u0644\u0633\u0644\u0627\u062D:</b> \u0634\u0628\u0643\u0629 \u0623\u0633\u0644\u062D\u0629 \u062C\u062F\u064A\u062F\u0629. \u0646\u0641\u0633 \u0627\u0644\u0637\u0631\u064A\u0642\u0629 \u2014 \u062F\u0644\u0627\u0626\u0644\u060C \u0646\u0642\u0627\u0634\u060C \u0627\u0644\u0642\u0627\u0636\u064A \u064A\u0642\u0631\u0631. \u0627\u0644\u0627\u062E\u062A\u064A\u0627\u0631 \u0627\u0644\u062E\u0627\u0637\u0626 \u064A\u0646\u0647\u064A \u0627\u0644\u0644\u0639\u0628\u0629 \u0641\u0648\u0631\u0627\u064B.',
  rR3:'<b style="color:var(--purple)">\u0627\u0644\u062C\u0648\u0644\u0629 \u0663 \u2014 \u0645\u0646 \u0627\u0644\u0641\u0627\u0639\u0644:</b> \u0627\u0644\u0642\u0627\u0636\u064A \u064A\u062E\u062A\u0627\u0631 \u0645\u0646 \u064A\u0639\u062A\u0642\u062F \u0623\u0646\u0647 \u0627\u0644\u0645\u0634\u062A\u0628\u0647 \u0628\u0647. \u062B\u0645 \u0643\u0644 \u0645\u0634\u062A\u0628\u0647 \u0628\u0647 \u064A\u062E\u0645\u0646 \u0633\u0631\u0627\u064B \u0645\u0646 \u0647\u0648 \u0627\u0644\u0634\u0627\u0647\u062F.',
  rTeamW:'<b style="color:var(--green)">\u0641\u0648\u0632 \u0627\u0644\u0641\u0631\u064A\u0642:</b> \u0627\u0644\u0642\u0627\u0636\u064A \u064A\u062E\u0645\u0646 \u0627\u0644\u0643\u0644\u0645\u062A\u064A\u0646 \u0628\u0634\u0643\u0644 \u0635\u062D\u064A\u062D \u0648\u0627\u0644\u0634\u0627\u0647\u062F \u064A\u0628\u0642\u0649 \u0645\u062E\u0641\u064A\u0627\u064B.',
  rSusW:'<b style="color:var(--red)">\u0641\u0648\u0632 \u0627\u0644\u0645\u0634\u062A\u0628\u0647 \u0628\u0647\u0645:</b> \u0627\u0644\u0642\u0627\u0636\u064A \u064A\u062E\u062A\u0627\u0631 \u0643\u0644\u0645\u0629 \u062E\u0627\u0637\u0626\u0629 \u0623\u0648 \u0645\u0634\u062A\u0628\u0647 \u0628\u0647 \u064A\u0643\u0634\u0641 \u0627\u0644\u0634\u0627\u0647\u062F.',
  guessed:' \u062E\u0645\u0651\u0646 ',
  loc:'\u0627\u0644\u0645\u0648\u0642\u0639', weap:'\u0627\u0644\u0633\u0644\u0627\u062D',
  localWifi:'\u0634\u0628\u0643\u0629 \u0645\u062D\u0644\u064A\u0629', localWifiSub:'\u0627\u0644\u062C\u0645\u064A\u0639 \u0639\u0644\u0649 \u0646\u0641\u0633 \u0627\u0644\u0634\u0628\u0643\u0629',
}
};

function t(key) { return (TR[currentLang] && TR[currentLang][key]) || TR.en[key] || key; }
function tRole(role) { return t(role) || role; }

function setLang(lang) {
  currentLang = lang;
  localStorage.setItem('det-lang', lang);
  document.documentElement.dir = lang === 'ar' ? 'rtl' : 'ltr';
  document.documentElement.lang = lang;
  document.documentElement.style.setProperty('--ls', lang === 'ar' ? '0px' : '4px');
  document.documentElement.style.setProperty('--ls-sm', lang === 'ar' ? '0px' : '1.5px');
  document.documentElement.style.setProperty('--ls-code', lang === 'ar' ? '8px' : '12px');
  translateStaticUI();
}

function toggleLang() {
  setLang(currentLang === 'en' ? 'ar' : 'en');
}

function translateStaticUI() {
  const L = TR[currentLang];
  // Menu
  const menuTitle = document.querySelector('#s-menu h1');
  if (menuTitle) menuTitle.textContent = L.title;
  const menuBtns = document.querySelectorAll('#s-menu .btn');
  if (menuBtns[0]) menuBtns[0].textContent = L.createGame;
  if (menuBtns[1]) menuBtns[1].textContent = L.joinGame;
  if (menuBtns[2]) menuBtns[2].textContent = L.howToPlay;
  // Lang toggle
  const lb = document.getElementById('lang-btn');
  if (lb) lb.textContent = L.langBtn;
  // Create screen
  const cs = document.getElementById('s-create');
  if (cs) {
    cs.querySelector('h2').textContent = L.createTitle;
    cs.querySelector('h3').textContent = L.createSub;
    cs.querySelector('input').placeholder = L.namePH;
    const btns = cs.querySelectorAll('.btn');
    btns[0].textContent = L.createRoom;
    btns[1].textContent = L.back;
  }
  // Join screen
  const js = document.getElementById('s-join');
  if (js) {
    js.querySelector('h2').textContent = L.joinTitle;
    js.querySelector('h3').textContent = L.joinSub;
    js.querySelectorAll('input')[0].placeholder = L.codePH;
    js.querySelectorAll('input')[1].placeholder = L.namePH;
    const btns = js.querySelectorAll('.btn');
    btns[0].textContent = L.joinRoom;
    btns[1].textContent = L.back;
  }
  // Rules screen
  const rs = document.getElementById('s-rules');
  if (rs) {
    rs.querySelector('h2').textContent = L.rulesTitle || L.howToPlay;
    const card = rs.querySelector('.card');
    if (card) {
      const ps = card.querySelectorAll('p');
      const divs = [L.rSetup, L.rRoles, L.rJudge, L.rWitness, L.rDetective, L.rSuspect, L.rR1, L.rR2, L.rR3, L.rTeamW, L.rSusW];
      ps.forEach((p, i) => { if (divs[i]) p.innerHTML = divs[i]; });
    }
    rs.querySelector('.btn').textContent = L.back;
  }
  // Lobby
  document.querySelector('#s-lobby h3').textContent = L.roomCode;
  const shareBtn = document.querySelector('#s-lobby .btn-sm');
  if (shareBtn) shareBtn.textContent = L.shareCode;
  const setToggle = document.querySelector('.settings-toggle span:first-child');
  if (setToggle) setToggle.textContent = L.gameSettings;
  // Settings labels
  const rows = document.querySelectorAll('.setting-row');
  const settingKeys = [['sMinP','sMinPd'],['sMaxP','sMaxPd'],['sSus','sSusd'],['sGrid','sGridd'],['sPrep','sPrepd'],['sDisc','sDiscd'],['sJudge','sJudged']];
  rows.forEach((row, i) => {
    if (settingKeys[i]) {
      const label = row.querySelector('.setting-label');
      if (label) {
        const sm = label.querySelector('small');
        label.childNodes[0].textContent = L[settingKeys[i][0]];
        if (sm) sm.textContent = L[settingKeys[i][1]];
      }
    }
  });
  // Auto option in suspects select
  const susSelect = document.getElementById('set-suspects');
  if (susSelect && susSelect.options[0]) susSelect.options[0].textContent = L.auto;
  // Lobby buttons
  const startBtn = document.getElementById('btn-start-game');
  if (startBtn) startBtn.textContent = L.startGame;
  const lobbyWait = document.getElementById('lobby-wait');
  if (lobbyWait) lobbyWait.innerHTML = L.waitHost + '<span class="dots"></span>';
  const lobbyLeave = document.querySelector('#s-lobby .btn-outline[onclick="leaveGame()"]');
  if (lobbyLeave) lobbyLeave.textContent = L.leaveGame;
  // Role reveal
  const roleH3 = document.querySelector('#s-role h3');
  if (roleH3) roleH3.textContent = L.yourRole;
  const readyBtn = document.getElementById('btn-ready');
  if (readyBtn) readyBtn.textContent = L.ready;
  const readyWait = document.getElementById('ready-wait');
  if (readyWait) readyWait.innerHTML = L.waitOthers + '<span class="dots"></span>';
  // Loading
  const loadTitle = document.getElementById('loading-title');
  if (loadTitle) loadTitle.textContent = L.waitPlayers;
  const loadSub = document.getElementById('loading-sub');
  if (loadSub) loadSub.textContent = L.everyoneConfirm;
  // Judge screen
  const decideLabel = document.querySelector('#s-judge .timer-label');
  if (decideLabel) decideLabel.textContent = L.decideOrLose;
  const judgeWait = document.getElementById('judge-waiting');
  if (judgeWait) judgeWait.innerHTML = L.waitJudge + '<span class="dots"></span>';
  const judgeConfirm = document.getElementById('btn-judge-confirm');
  if (judgeConfirm) judgeConfirm.textContent = L.confirmSel;
  // Result screen
  const nextBtn = document.getElementById('btn-next-stage');
  if (nextBtn) nextBtn.textContent = L.nextStage;
  const resultWait = document.getElementById('result-wait');
  if (resultWait) resultWait.innerHTML = L.continuing + '<span class="dots"></span>';
  // Suspect screen
  const susConfirm = document.getElementById('btn-suspect-confirm');
  if (susConfirm && susConfirm.textContent !== L.voteSubmitted) susConfirm.textContent = L.confirmGuess;
  const susWait = document.getElementById('suspect-wait');
  if (susWait) susWait.innerHTML = L.susVoting + '<span class="dots"></span>';
  // Game over
  const playAgainBtn = document.getElementById('btn-play-again');
  if (playAgainBtn) playAgainBtn.textContent = L.playAgain;
  const goLeave = document.querySelector('#s-gameover .btn-outline');
  if (goLeave) goLeave.textContent = L.leaveGame;
  // Disconnect overlay
  const dcH2 = document.querySelector('#disconnect-overlay h2');
  if (dcH2) dcH2.textContent = L.disconnected;
  const dcBtn = document.querySelector('#disconnect-overlay .btn');
  if (dcBtn) dcBtn.textContent = L.backMenu;
  // End discussion button
  const endDisc = document.getElementById('btn-end-discuss');
  if (endDisc) endDisc.textContent = L.endDiscEarly;
  // Update role card front text via CSS custom property
  document.documentElement.style.setProperty('--tap-text', '"' + L.tapReveal + '"');
}

// ======================== STATE ========================
const NET = {
  peer: null,
  connections: {},   // host: {peerId: {conn, name}}
  hostConn: null,    // non-host: connection to host
  isHost: false,
  roomCode: '',
  myName: '',
  myId: '',
  players: [],       // [{name, id}]
  heartbeat: null,
};

let G = {
  myRole: '',
  locationHint: '',
  weaponHint: '',
  locationWord: '',
  weaponWord: '',
  phase: '',
  locationGrid: [],
  weaponGrid: [],
  players: [],
  roles: {},
  timerTotal: 0,
  timerRemaining: 0,
  judgeSelection: null,
  suspectVote: null,
  gridCols: 3,
};

let HOST = null;

// ======================== LOCAL WIFI TRANSPORT ========================
const LOCAL = {
  active: false,
  baseUrl: '',
  pollInterval: null,
  pollTs: 0,
};

function isLocalServer() {
  const h = location.hostname;
  return h === 'localhost' || h === '127.0.0.1' || /^192\.168\./.test(h) || /^10\./.test(h) || /^172\.(1[6-9]|2\d|3[01])\./.test(h);
}

async function localApi(body) {
  const res = await fetch(LOCAL.baseUrl + '/api/room', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(body),
  });
  return res.json();
}

function startLocalPoll() {
  if (LOCAL.pollInterval) clearInterval(LOCAL.pollInterval);
  LOCAL.pollTs = Date.now();
  LOCAL.pollInterval = setInterval(async () => {
    try {
      const res = await localApi({ action: 'poll', room: NET.roomCode, name: NET.myName, since: LOCAL.pollTs });
      if (res.ok && res.msgs) {
        LOCAL.pollTs = res.ts;
        res.msgs.forEach(m => {
          if (NET.isHost) {
            handleHostReceive(null, { ...m.msg, _fromName: m.from, _fromHost: m.from === NET.myName });
          } else {
            handleClientReceive(m.msg);
          }
        });
      }
    } catch (e) { /* ignore poll errors */ }
  }, 300);
}

function stopLocalPoll() {
  if (LOCAL.pollInterval) { clearInterval(LOCAL.pollInterval); LOCAL.pollInterval = null; }
}

// ======================== UTILITIES ========================
function esc(s) { const d = document.createElement('div'); d.textContent = s; return d.innerHTML; }

function shuffle(arr) {
  const a = [...arr];
  for (let i = a.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [a[i], a[j]] = [a[j], a[i]]; }
  return a;
}

function generateRoomCode() {
  const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ';
  let code = '';
  for (let i = 0; i < 4; i++) code += chars[Math.floor(Math.random() * chars.length)];
  return code;
}

function toast(msg, type = 'info') {
  const el = document.createElement('div');
  el.className = 'toast ' + type;
  el.textContent = msg;
  document.getElementById('toast-container').appendChild(el);
  setTimeout(() => { el.style.opacity = '0'; el.style.transition = 'opacity .3s'; setTimeout(() => el.remove(), 300); }, 3000);
}

function getRoleDistribution(count) {
  const susSetting = SETTINGS.suspects;
  let suspects;
  if (susSetting === 'auto') {
    suspects = 1;
    if (count >= 6) suspects = 2;
    if (count >= 9) suspects = 3;
  } else {
    suspects = parseInt(susSetting);
  }
  // Clamp: need at least judge + witness + 1 detective, so max suspects = count - 3
  suspects = Math.max(0, Math.min(suspects, count - 3));
  const detectives = Math.max(0, count - 2 - suspects);
  return { judge: 1, witness: 1, suspects, detectives };
}

// ======================== HOST SETTINGS ========================
const SETTINGS = {
  minPlayers: 4,
  maxPlayers: 10,
  suspects: 'auto',
  gridSize: 9,
  prepTime: 30,
  discussTime: 90,
  judgeTime: 15,
};

function toggleSettings() {
  const panel = document.getElementById('settings-panel');
  const arrow = document.getElementById('settings-arrow');
  panel.classList.toggle('open');
  arrow.classList.toggle('open');
}

function adjSetting(key, delta) {
  const input = document.getElementById('set-' + key);
  let val = parseInt(input.value) + delta;
  val = Math.max(parseInt(input.min), Math.min(parseInt(input.max), val));
  input.value = val;
  onSettingChange();
}

function readSettings() {
  SETTINGS.minPlayers = clampInt('set-minPlayers', 2, 20);
  SETTINGS.maxPlayers = clampInt('set-maxPlayers', 2, 20);
  if (SETTINGS.maxPlayers < SETTINGS.minPlayers) {
    SETTINGS.maxPlayers = SETTINGS.minPlayers;
    document.getElementById('set-maxPlayers').value = SETTINGS.maxPlayers;
  }
  SETTINGS.suspects = document.getElementById('set-suspects').value;
  SETTINGS.gridSize = parseInt(document.getElementById('set-gridSize').value);
  SETTINGS.prepTime = clampInt('set-prepTime', 10, 120);
  SETTINGS.discussTime = clampInt('set-discussTime', 30, 300);
  SETTINGS.judgeTime = clampInt('set-judgeTime', 10, 60);
}

function clampInt(id, min, max) {
  const el = document.getElementById(id);
  let v = parseInt(el.value) || min;
  v = Math.max(min, Math.min(max, v));
  el.value = v;
  return v;
}

function onSettingChange() {
  readSettings();
  showLobby();
}

// ======================== SCREEN MANAGEMENT ========================
function showScreen(id) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
}

// ======================== NETWORKING ========================
const PEER_CONFIG = {
  debug: 1,
  config: {
    iceServers: [
      { urls: 'stun:stun.l.google.com:19302' },
      { urls: 'stun:stun1.l.google.com:19302' },
      { urls: 'stun:stun2.l.google.com:19302' },
      { urls: 'stun:stun.relay.metered.ca:80' },
      { urls: 'turn:global.relay.metered.ca:80', username: 'e7e5e3e1d3c3b3a3', credential: 'openRelayProject' },
      { urls: 'turn:global.relay.metered.ca:443', username: 'e7e5e3e1d3c3b3a3', credential: 'openRelayProject' },
    ]
  }
};

function makePeer(id) {
  const opts = { ...PEER_CONFIG };
  return id ? new Peer(id, opts) : new Peer(opts);
}

function setupHostListeners(peer) {
  peer.on('connection', (conn) => {
    conn.on('open', () => { /* wait for join message */ });
    conn.on('data', (data) => handleHostReceive(conn, data));
    conn.on('close', () => handlePlayerDisconnect(conn.peer));
    conn.on('error', () => handlePlayerDisconnect(conn.peer));
  });
}

async function createRoom() {
  const name = document.getElementById('host-name-input').value.trim();
  if (!name) { toast(t('enterName'), 'error'); return; }

  if (LOCAL.active) {
    NET.myName = name;
    NET.isHost = true;
    NET.roomCode = generateRoomCode();
    NET.myId = 'host-' + NET.roomCode;
    NET.players = [{ name: NET.myName, id: NET.myId }];

    document.getElementById('btn-create').disabled = true;
    document.getElementById('create-status').textContent = t('creatingRoom');

    try {
      const res = await localApi({ action: 'create', room: NET.roomCode, name: NET.myName });
      if (res.ok) {
        showLobby();
        toast(t('roomCreated'), 'success');
        startLocalPoll();
      } else {
        toast(res.error || 'Error', 'error');
        document.getElementById('btn-create').disabled = false;
        document.getElementById('create-status').textContent = '';
      }
    } catch (e) {
      toast(t('connErr') + e.message, 'error');
      document.getElementById('btn-create').disabled = false;
      document.getElementById('create-status').textContent = '';
    }
    return;
  }

  document.getElementById('btn-create').disabled = true;
  document.getElementById('create-status').textContent = t('creatingRoom');

  NET.myName = name;
  NET.isHost = true;
  NET.roomCode = generateRoomCode();
  const peerId = 'detectives-' + NET.roomCode;

  NET.peer = makePeer(peerId);

  NET.peer.on('open', (id) => {
    NET.myId = id;
    NET.players = [{ name: NET.myName, id: NET.myId }];
    showLobby();
    toast(t('roomCreated'), 'success');
  });

  setupHostListeners(NET.peer);

  NET.peer.on('error', (err) => {
    if (err.type === 'unavailable-id') {
      NET.peer.destroy();
      NET.roomCode = generateRoomCode();
      NET.peer = makePeer('detectives-' + NET.roomCode);
      NET.peer.on('open', (id) => {
        NET.myId = id;
        NET.players = [{ name: NET.myName, id: NET.myId }];
        showLobby();
        toast(t('roomCreated'), 'success');
      });
      setupHostListeners(NET.peer);
      NET.peer.on('error', handlePeerError);
    } else {
      handlePeerError(err);
    }
  });

  // Timeout â€” if PeerJS cloud doesn't respond in 10s, show error
  setTimeout(() => {
    if (!NET.myId) {
      toast('PeerJS server not responding. Try again or use Local WiFi mode.', 'error');
      document.getElementById('btn-create').disabled = false;
      document.getElementById('create-status').textContent = '';
      if (NET.peer) { try { NET.peer.destroy(); } catch(e){} }
    }
  }, 10000);
}

async function joinRoom() {
  const code = document.getElementById('join-code-input').value.trim().toUpperCase();
  const name = document.getElementById('join-name-input').value.trim();
  if (!code || code.length !== 4) { toast(t('enterCode'), 'error'); return; }
  if (!name) { toast(t('enterName'), 'error'); return; }

  if (LOCAL.active) {
    NET.myName = name;
    NET.isHost = false;
    NET.roomCode = code;
    NET.myId = 'player-' + name + '-' + Date.now();

    document.getElementById('btn-join').disabled = true;
    document.getElementById('join-status').textContent = t('connectingDots');

    try {
      const res = await localApi({ action: 'join', room: code, name: name });
      if (res.ok) {
        await localApi({ action: 'send', room: code, from: name, to: '*', msg: { type: 'join', name: name } });
        startLocalPoll();
      } else {
        toast(res.error || t('roomNotFound'), 'error');
        document.getElementById('btn-join').disabled = false;
        document.getElementById('join-status').textContent = '';
      }
    } catch (e) {
      toast(t('cantConnect'), 'error');
      document.getElementById('btn-join').disabled = false;
      document.getElementById('join-status').textContent = '';
    }
    return;
  }

  document.getElementById('btn-join').disabled = true;
  document.getElementById('join-status').textContent = t('connectingDots');

  NET.myName = name;
  NET.isHost = false;
  NET.roomCode = code;

  NET.peer = makePeer();

  NET.peer.on('open', (id) => {
    NET.myId = id;
    const hostId = 'detectives-' + code;
    const conn = NET.peer.connect(hostId, { reliable: true, serialization: 'json' });

    conn.on('open', () => {
      NET.hostConn = conn;
      conn.send({ type: 'join', name: NET.myName, id: NET.myId });
    });

    conn.on('data', (data) => handleClientReceive(data));

    conn.on('close', () => {
      showDisconnect(t('hostDC'));
    });

    conn.on('error', () => {
      showDisconnect(t('hostLost'));
    });

    // Timeout for connection
    setTimeout(() => {
      if (!NET.hostConn) {
        toast(t('cantConnect'), 'error');
        document.getElementById('btn-join').disabled = false;
        document.getElementById('join-status').textContent = '';
        if (NET.peer) NET.peer.destroy();
      }
    }, 8000);
  });

  NET.peer.on('error', (err) => {
    if (err.type === 'peer-unavailable') {
      toast(t('roomNotFound'), 'error');
      document.getElementById('btn-join').disabled = false;
      document.getElementById('join-status').textContent = '';
    } else {
      handlePeerError(err);
    }
  });
}

function handlePeerError(err) {
  console.error('PeerJS error:', err.type, err.message, err);
  let msg = err.type || err.message || 'Unknown error';
  if (err.type === 'network') msg = 'Network error â€” check your internet connection';
  else if (err.type === 'server-error') msg = 'PeerJS server error â€” try again in a moment';
  else if (err.type === 'socket-error') msg = 'Connection failed â€” server may be down';
  else if (err.type === 'socket-closed') msg = 'Connection dropped â€” try again';
  toast(t('connErr') + msg, 'error');
  document.getElementById('btn-create').disabled = false;
  document.getElementById('btn-join').disabled = false;
  document.getElementById('create-status').textContent = '';
  document.getElementById('join-status').textContent = '';
}

function broadcast(msg) {
  if (LOCAL.active) {
    localApi({ action: 'send', room: NET.roomCode, from: NET.myName, to: '*', msg: msg });
    // Host also processes the message locally
    handleClientReceive(msg);
    return;
  }
  Object.values(NET.connections).forEach(({ conn }) => {
    if (conn.open) conn.send(msg);
  });
  // Host also processes the message
  handleClientReceive(msg);
}

function sendToHost(msg) {
  if (LOCAL.active) {
    if (NET.isHost) {
      handleHostReceive(null, { ...msg, _fromHost: true, _fromName: NET.myName });
    } else {
      localApi({ action: 'send', room: NET.roomCode, from: NET.myName, to: '__HOST__', msg: msg });
    }
    return;
  }
  if (NET.isHost) {
    handleHostReceive(null, { ...msg, _fromHost: true });
  } else if (NET.hostConn && NET.hostConn.open) {
    NET.hostConn.send(msg);
  }
}

function sendToPlayer(targetId, msg) {
  if (LOCAL.active) {
    if (targetId === NET.myId) {
      handleClientReceive(msg);
    } else {
      // In local mode, find player name from NET.players by id
      const player = NET.players.find(p => p.id === targetId);
      if (player) {
        localApi({ action: 'send', room: NET.roomCode, from: NET.myName, to: player.name, msg: msg });
      }
    }
    return;
  }
  if (targetId === NET.myId) {
    handleClientReceive(msg);
  } else {
    const c = NET.connections[targetId];
    if (c && c.conn.open) c.conn.send(msg);
  }
}

// ======================== HOST MESSAGE HANDLER ========================
function handleHostReceive(conn, data) {
  const senderId = data._fromHost ? NET.myId : (conn ? conn.peer : (data._fromName ? ('local-' + data._fromName) : null));

  switch (data.type) {
    case 'join': {
      if (NET.players.length >= SETTINGS.maxPlayers) {
        if (LOCAL.active && data._fromName) {
          localApi({ action: 'send', room: NET.roomCode, from: NET.myName, to: data._fromName, msg: { type: 'error', msg: t('roomFull') } });
        } else if (conn) { conn.send({ type: 'error', msg: t('roomFull') }); }
        return;
      }
      if (NET.players.some(p => p.name === data.name)) {
        if (LOCAL.active && data._fromName) {
          localApi({ action: 'send', room: NET.roomCode, from: NET.myName, to: data._fromName, msg: { type: 'error', msg: t('nameTaken') } });
        } else if (conn) { conn.send({ type: 'error', msg: t('nameTaken') }); }
        return;
      }
      if (LOCAL.active) {
        const fakeId = 'local-' + data.name;
        NET.connections[fakeId] = { conn: null, name: data.name };
        NET.players.push({ name: data.name, id: fakeId });
        broadcast({ type: 'lobby', players: NET.players, roomCode: NET.roomCode });
        toast(data.name + t('xJoined'), 'success');
      } else if (conn) {
        NET.connections[conn.peer] = { conn, name: data.name };
        NET.players.push({ name: data.name, id: conn.peer });
        broadcast({ type: 'lobby', players: NET.players, roomCode: NET.roomCode });
        toast(data.name + t('xJoined'), 'success');
      } else {
        NET.players.push({ name: data.name, id: NET.myId });
        broadcast({ type: 'lobby', players: NET.players, roomCode: NET.roomCode });
        toast(data.name + t('xJoined'), 'success');
      }
      break;
    }
    case 'ready': {
      if (HOST && HOST.readySet) {
        HOST.readySet.add(data.name);
        if (HOST.readySet.size >= NET.players.length) {
          startFirstPhase();
        }
      }
      break;
    }
    case 'judge-pick': {
      if (!HOST) return;
      // Cancel the decision timer
      if (HOST.timerInterval) { clearInterval(HOST.timerInterval); HOST.timerInterval = null; }
      HOST.judgeGuesses[data.stage] = data.value;
      if (data.stage === 'location' || data.stage === 'weapon') {
        const correct = data.stage === 'location' ? HOST.correctLocation : HOST.correctWeapon;
        const isCorrect = data.value === correct;
        if (isCorrect) {
          broadcast({ type: 'result', stage: data.stage, correct: true, guessed: data.value, actual: correct });
        } else {
          // Wrong answer â€” immediate game over, suspects win
          broadcast({
            type: 'gameover',
            teamWins: false,
            locCorrect: data.stage === 'location' ? false : null,
            weapCorrect: data.stage === 'weapon' ? false : null,
            witnessExposed: false,
            judgeGuesses: HOST.judgeGuesses,
            suspectVotes: {},
            correctLocation: HOST.correctLocation,
            correctWeapon: HOST.correctWeapon,
            roles: HOST.roles
          });
        }
      } else if (data.stage === 'suspect') {
        HOST.judgeGuesses.suspect = data.value;
        broadcast({ type: 'phase', phase: 'suspect_guess' });
      }
      break;
    }
    case 'end-discussion': {
      if (HOST && HOST.timerInterval) {
        clearInterval(HOST.timerInterval);
        HOST.timerInterval = null;
        const stage = G.phase.includes('location') ? 'location' : 'weapon';
        hostStartJudgePhase(stage);
      }
      break;
    }
    case 'next-stage': {
      if (!HOST) return;
      if (G.phase === 'location_result') {
        const prep = HOST.settings.prepTime;
        const disc = HOST.settings.discussTime;
        broadcast({ type: 'phase', phase: 'weapon_prep', timer: prep });
        hostStartTimer(prep, () => {
          broadcast({ type: 'phase', phase: 'weapon_discuss', timer: disc });
          hostStartTimer(disc, () => {
            hostStartJudgePhase('weapon');
          });
        });
      } else if (G.phase === 'weapon_result') {
        hostStartJudgePhase('suspect');
      }
      break;
    }
    case 'suspect-vote': {
      if (!HOST) return;
      HOST.suspectVotes[data.name] = data.target;
      const suspectNames = Object.keys(HOST.roles).filter(n => HOST.roles[n] === 'Suspect');
      const votedCount = suspectNames.filter(n => HOST.suspectVotes[n]).length;
      if (votedCount >= suspectNames.length) {
        // All suspects voted â€” check if any got the witness
        const witnessName = Object.keys(HOST.roles).find(n => HOST.roles[n] === 'Witness');
        const witnessExposed = suspectNames.some(n => HOST.suspectVotes[n] === witnessName);
        const locCorrect = HOST.judgeGuesses.location === HOST.correctLocation;
        const weapCorrect = HOST.judgeGuesses.weapon === HOST.correctWeapon;
        const teamWins = locCorrect && weapCorrect && !witnessExposed;

        broadcast({
          type: 'gameover',
          teamWins,
          locCorrect,
          weapCorrect,
          witnessExposed,
          judgeGuesses: HOST.judgeGuesses,
          suspectVotes: HOST.suspectVotes,
          correctLocation: HOST.correctLocation,
          correctWeapon: HOST.correctWeapon,
          roles: HOST.roles
        });
      }
      break;
    }
    case 'play-again': {
      if (HOST && HOST.timerInterval) clearInterval(HOST.timerInterval);
      HOST = null;
      broadcast({ type: 'lobby', players: NET.players, roomCode: NET.roomCode });
      break;
    }
  }
}

// ======================== CLIENT MESSAGE HANDLER ========================
function handleClientReceive(data) {
  switch (data.type) {
    case 'lobby':
      NET.players = data.players;
      NET.roomCode = data.roomCode;
      G.myRole = '';
      G.phase = '';
      G.judgeSelection = null;
      G.suspectVote = null;
      showLobby();
      break;
    case 'error':
      toast(data.msg, 'error');
      document.getElementById('btn-join').disabled = false;
      document.getElementById('join-status').textContent = '';
      break;
    case 'role': {
      G.myRole = data.role;
      G.locationHint = data.locationHint || '';
      G.weaponHint = data.weaponHint || '';
      G.locationWord = data.locationWord || '';
      G.weaponWord = data.weaponWord || '';
      G.locationGrid = data.locationGrid;
      G.weaponGrid = data.weaponGrid;
      G.players = data.players;
      G.gridCols = data.gridCols || 3;
      G.phase = 'role_reveal';
      showRoleReveal();
      break;
    }
    case 'phase':
      G.phase = data.phase;
      G.timerTotal = data.timer || 0;
      G.timerRemaining = data.timer || 0;
      G.judgeSelection = null;
      G.suspectVote = null;
      document.getElementById('urgent-border').classList.remove('active');
      renderPhase();
      break;
    case 'tick':
      G.timerRemaining = data.t;
      updateTimerDisplay();
      break;
    case 'result':
      G.phase = data.stage + '_result';
      showStageResult(data);
      break;
    case 'gameover':
      G.phase = 'gameover';
      G.roles = data.roles;
      showGameOver(data);
      break;
  }
}

function handlePlayerDisconnect(peerId) {
  const entry = NET.connections[peerId];
  if (entry) {
    toast(entry.name + t('xDisc'), 'error');
    NET.players = NET.players.filter(p => p.id !== peerId);
    delete NET.connections[peerId];
    // Update lobby if still in lobby
    if (G.phase === '' || G.phase === 'lobby') {
      broadcast({ type: 'lobby', players: NET.players, roomCode: NET.roomCode });
    }
  }
}

function showDisconnect(msg) {
  document.getElementById('disconnect-msg').textContent = msg;
  document.getElementById('disconnect-overlay').style.display = 'flex';
}

function leaveGame() {
  if (LOCAL.active) {
    stopLocalPoll();
    localApi({ action: 'leave', room: NET.roomCode, name: NET.myName }).catch(() => {});
  }
  if (NET.peer) NET.peer.destroy();
  clearInterval(NET.heartbeat);
  location.reload();
}

// ======================== LOBBY ========================
function showLobby() {
  document.getElementById('lobby-code').textContent = NET.roomCode;
  document.getElementById('lobby-count').textContent = `${t('playersOf')} (${NET.players.length}/${SETTINGS.maxPlayers})`;

  const listEl = document.getElementById('lobby-players');
  listEl.innerHTML = NET.players.map((p, i) =>
    `<div class="lobby-player"><span class="dot"></span><span class="name">${esc(p.name)}</span>${i === 0 ? '<span class="host-tag">' + (currentLang === 'ar' ? '\u0645\u0636\u064A\u0641' : 'HOST') + '</span>' : ''}</div>`
  ).join('');

  // Show settings panel for host only
  document.getElementById('host-settings-wrap').style.display = NET.isHost ? 'block' : 'none';

  const startBtn = document.getElementById('btn-start-game');
  const waitMsg = document.getElementById('lobby-wait');

  if (NET.isHost) {
    startBtn.style.display = 'block';
    startBtn.disabled = NET.players.length < SETTINGS.minPlayers;
    waitMsg.style.display = 'none';
  } else {
    startBtn.style.display = 'none';
    waitMsg.style.display = 'block';
  }

  // Role preview
  const preview = document.getElementById('lobby-role-preview');
  if (NET.players.length >= SETTINGS.minPlayers) {
    const d = getRoleDistribution(NET.players.length);
    preview.style.display = 'block';
    preview.innerHTML = `<b>${NET.players.length} ${t('pPlayers')}:</b> ${d.judge} ${t('Judge')} &bull; ${d.witness} ${t('Witness')} &bull; ${d.suspects} ${t('Suspect')}${d.suspects>1?'s':''} &bull; ${d.detectives} ${t('Detective')}${d.detectives>1?'s':''}`;
  } else {
    preview.style.display = 'block';
    preview.innerHTML = `<span style="color:var(--text3)">${t('need')} ${SETTINGS.minPlayers} ${t('toStart')}</span>`;
  }

  showScreen('s-lobby');
}

function shareRoom() {
  const text = `Join my Detectives game!\nRoom code: ${NET.roomCode}`;
  if (navigator.share) {
    navigator.share({ title: 'Detectives', text }).catch(() => {});
  } else {
    navigator.clipboard.writeText(NET.roomCode).then(() => toast(t('codeCopied'), 'success')).catch(() => {});
  }
}

// ======================== HOST: START GAME ========================
function hostStartGame() {
  readSettings();
  if (NET.players.length < SETTINGS.minPlayers) return;
  document.getElementById('btn-start-game').disabled = true;

  HOST = {
    roles: {},
    correctLocation: '',
    correctWeapon: '',
    locationGrid: [],
    weaponGrid: [],
    hints: {},
    readySet: new Set(),
    timerInterval: null,
    timerRemaining: 0,
    judgeGuesses: { location: null, weapon: null, suspect: null },
    suspectVotes: {},
    settings: { ...SETTINGS },
  };

  const names = NET.players.map(p => p.name);
  const dist = getRoleDistribution(names.length);
  const shuffled = shuffle(names);

  HOST.roles[shuffled[0]] = 'Judge';
  HOST.roles[shuffled[1]] = 'Witness';
  for (let i = 2; i < 2 + dist.suspects; i++) HOST.roles[shuffled[i]] = 'Suspect';
  for (let i = 2 + dist.suspects; i < shuffled.length; i++) HOST.roles[shuffled[i]] = 'Detective';

  // Generate grids using configured grid size
  const gridCount = SETTINGS.gridSize;
  HOST.salt = Math.random().toString(36).slice(2, 10);
  const locShuffle = shuffle(LOCATIONS);
  HOST.correctLocation = locShuffle[0];
  HOST.locationGrid = shuffle(locShuffle.slice(0, gridCount)).map(w => ({ word: w }));

  const weapShuffle = shuffle(WEAPONS);
  HOST.correctWeapon = weapShuffle[0];
  HOST.weaponGrid = shuffle(weapShuffle.slice(0, gridCount)).map(w => ({ word: w }));

  // Generate hints for detectives
  names.forEach(name => {
    if (HOST.roles[name] === 'Detective') {
      HOST.hints[name] = {
        location: getHint(HOST.correctLocation),
        weapon: getHint(HOST.correctWeapon)
      };
    }
  });

  // Compute grid columns for CSS
  const gridCols = Math.round(Math.sqrt(gridCount));

  // Send private role data to each player
  NET.players.forEach(p => {
    const role = HOST.roles[p.name];
    const msg = {
      type: 'role',
      role,
      locationGrid: HOST.locationGrid,
      weaponGrid: HOST.weaponGrid,
      players: names,
      locationHint: '',
      weaponHint: '',
      locationWord: '',
      weaponWord: '',
      gridCols,
    };

    if (role === 'Witness') {
      msg.locationWord = HOST.correctLocation;
      msg.weaponWord = HOST.correctWeapon;
    } else if (role === 'Detective') {
      msg.locationHint = HOST.hints[p.name].location;
      msg.weaponHint = HOST.hints[p.name].weapon;
    } else if (role === 'Suspect') {
      msg.locationWord = HOST.correctLocation;
      msg.weaponWord = HOST.correctWeapon;
    }

    sendToPlayer(p.id, msg);
  });
}

function startFirstPhase() {
  const prep = HOST.settings.prepTime;
  const disc = HOST.settings.discussTime;
  broadcast({ type: 'phase', phase: 'location_prep', timer: prep });
  hostStartTimer(prep, () => {
    broadcast({ type: 'phase', phase: 'location_discuss', timer: disc });
    hostStartTimer(disc, () => {
      hostStartJudgePhase('location');
    });
  });
}

function hostStartJudgePhase(stage) {
  const jt = HOST.settings.judgeTime;
  broadcast({ type: 'phase', phase: stage + '_judge', timer: jt });
  hostStartTimer(jt, () => {
    // Time's up â€” suspects win!
    broadcast({
      type: 'gameover',
      teamWins: false,
      locCorrect: HOST.judgeGuesses.location === HOST.correctLocation,
      weapCorrect: HOST.judgeGuesses.weapon === HOST.correctWeapon,
      witnessExposed: false,
      timedOut: stage,
      judgeGuesses: HOST.judgeGuesses,
      suspectVotes: {},
      correctLocation: HOST.correctLocation,
      correctWeapon: HOST.correctWeapon,
      roles: HOST.roles
    });
  });
}

function hostStartTimer(seconds, onDone) {
  if (HOST.timerInterval) clearInterval(HOST.timerInterval);
  HOST.timerRemaining = seconds;
  HOST.timerInterval = setInterval(() => {
    HOST.timerRemaining--;
    broadcast({ type: 'tick', t: HOST.timerRemaining });
    if (HOST.timerRemaining <= 0) {
      clearInterval(HOST.timerInterval);
      HOST.timerInterval = null;
      onDone();
    }
  }, 1000);
}

// ======================== ROLE REVEAL ========================
function showRoleReveal() {
  const card = document.getElementById('role-card');
  card.classList.remove('flipped');
  document.getElementById('btn-ready').style.display = 'none';
  document.getElementById('ready-wait').style.display = 'none';
  showScreen('s-role');
}

function flipRole() {
  const card = document.getElementById('role-card');
  if (card.classList.contains('flipped')) return;
  card.classList.add('flipped');
  document.getElementById('btn-ready').style.display = 'block';

  const role = G.myRole;
  const back = document.getElementById('role-back');

  let icon, color, infoHTML;
  if (role === 'Judge') {
    icon = '&#9878;&#65039;'; color = 'var(--gold)';
    infoHTML = '<div style="color:var(--text2);font-size:14px;margin-top:12px">' + t('judgeDesc') + '</div>';
  } else if (role === 'Witness') {
    icon = '&#128065;&#65039;'; color = 'var(--green)';
    infoHTML = `<div class="role-word">&#128205; ${esc(G.locationWord)}<br>&#128298; ${esc(G.weaponWord)}</div>
      <div style="color:var(--text2);font-size:13px;margin-top:8px">${t('witnessDesc')}</div>`;
  } else if (role === 'Detective') {
    icon = '&#128270;'; color = 'var(--blue)';
    infoHTML = '<div style="color:var(--text2);font-size:14px;margin-top:12px">' + t('detectiveDesc') + '</div>';
  } else {
    icon = '&#128308;'; color = 'var(--red)';
    infoHTML = `<div class="role-word">&#128205; ${esc(G.locationWord)}<br>&#128298; ${esc(G.weaponWord)}</div>
      <div style="color:var(--text2);font-size:13px;margin-top:8px">${t('suspectDesc')}</div>`;
  }

  back.innerHTML = `<div class="role-icon">${icon}</div><div class="role-name" style="color:${color}">${tRole(role)}</div>${infoHTML}`;
  back.style.background = 'linear-gradient(135deg, var(--card), var(--card2))';
}

function confirmReady() {
  document.getElementById('btn-ready').style.display = 'none';
  document.getElementById('loading-icon').textContent = '\u23F3';
  document.getElementById('loading-title').textContent = t('waitPlayers');
  document.getElementById('loading-sub').textContent = t('everyoneConfirm');
  document.getElementById('loading-progress').style.display = 'none';
  showScreen('s-loading');
  sendToHost({ type: 'ready', name: NET.myName });
}

// ======================== PHASE RENDERING ========================
function renderPhase() {
  const phase = G.phase;

  if (phase === 'location_prep' || phase === 'weapon_prep') {
    renderGameScreen('prep', phase.includes('location') ? 'location' : 'weapon');
  } else if (phase === 'location_discuss' || phase === 'weapon_discuss') {
    renderGameScreen('discuss', phase.includes('location') ? 'location' : 'weapon');
  } else if (phase === 'location_judge' || phase === 'weapon_judge') {
    renderJudgeScreen(phase.includes('location') ? 'location' : 'weapon');
  } else if (phase === 'suspect_judge') {
    renderJudgeScreen('suspect');
  } else if (phase === 'suspect_guess') {
    renderSuspectScreen();
  }
}

function renderGameScreen(mode, stage) {
  const isLoc = stage === 'location';
  const grid = isLoc ? G.locationGrid : G.weaponGrid;

  // Badge
  const badgeEl = document.getElementById('game-badge');
  badgeEl.innerHTML = isLoc
    ? '<div class="stage-badge loc">' + t('s1Loc') + '</div>'
    : '<div class="stage-badge weap">' + t('s2Weap') + '</div>';

  // Title
  document.getElementById('game-title').textContent = mode === 'prep'
    ? (isLoc ? t('readLoc') : t('readWeap'))
    : (isLoc ? t('locDisc') : t('weapDisc'));

  // Role info
  const roleInfoEl = document.getElementById('game-role-info');
  roleInfoEl.innerHTML = getRoleInfoHTML(stage);

  // Grid
  const gridEl = document.getElementById('game-grid');
  gridEl.innerHTML = grid.map(item => renderGridCell(item, false)).join('');
  gridEl.style.gridTemplateColumns = `repeat(${G.gridCols}, 1fr)`;

  // Timer
  document.getElementById('game-timer-label').textContent = mode === 'prep' ? t('PREP') : t('DISC');
  resetTimerRing(G.timerTotal);

  // Hint text
  document.getElementById('game-hint-text').textContent = mode === 'discuss'
    ? t('discHint')
    : t('prepHint');

  // End discussion button (judge only, during discussion)
  const endBtn = document.getElementById('btn-end-discuss');
  endBtn.style.display = (mode === 'discuss' && G.myRole === 'Judge') ? 'block' : 'none';

  showScreen('s-game');
}

function getRoleInfoHTML(stage) {
  const isLoc = stage === 'location';
  if (G.myRole === 'Judge') {
    return '<div class="role-info judge">' + t('judgeInfo') + '</div>';
  } else if (G.myRole === 'Witness') {
    const word = isLoc ? G.locationWord : G.weaponWord;
    return '<div class="role-info witness">&#128065;&#65039; ' + t('theWord') + ' ' + (isLoc ? t('locLabel') : t('weapLabel')) + ' ' + t('is') + '<span class="hint-word">' + esc(tWord(word)) + '</span></div>';
  } else if (G.myRole === 'Detective') {
    const hint = isLoc ? G.locationHint : G.weaponHint;
    return '<div class="role-info detective">&#128270; ' + t('clue') + '<span class="hint-word">"' + esc(hint) + '"</span></div>';
  } else {
    const word = isLoc ? G.locationWord : G.weaponWord;
    return '<div class="role-info suspect">&#128308; ' + t('knowAnswer') + '<span class="hint-word">' + esc(tWord(word)) + '</span></div>';
  }
}

function renderGridCell(item, interactive, onclick) {
  const cls = interactive ? 'word-cell interactive' : 'word-cell';
  const click = onclick ? ` onclick="${onclick}"` : '';
  const art = getCardArt(item.word);
  const [emoji, bgDark, accent] = art;
  return `<div class="${cls}"${click} data-word="${esc(item.word)}" style="background:linear-gradient(135deg,${bgDark},${bgDark}ee)">
    <div class="cell-accent" style="background:radial-gradient(circle at 50% 40%,${accent},transparent)"></div>
    <div class="cell-icon">${emoji}</div>
    <div class="cell-label">${esc(tWord(item.word))}</div>
  </div>`;
}

function endDiscussionEarly() {
  sendToHost({ type: 'end-discussion' });
}

// ======================== TIMER DISPLAY ========================
const CIRC = 2 * Math.PI * 44;

function resetTimerRing(total) {
  const fg = document.getElementById('game-timer-fg');
  const digits = document.getElementById('game-timer-digits');
  fg.style.strokeDasharray = CIRC;
  fg.style.strokeDashoffset = 0;
  fg.classList.remove('urgent');
  digits.textContent = total;
}

function updateTimerDisplay() {
  const total = G.timerTotal;
  const remaining = G.timerRemaining;
  const pct = total > 0 ? 1 - remaining / total : 0;

  // Update game screen timer (prep/discussion)
  const fg = document.getElementById('game-timer-fg');
  const digits = document.getElementById('game-timer-digits');
  const urgBorder = document.getElementById('urgent-border');
  if (fg && digits) {
    fg.style.strokeDashoffset = CIRC * pct;
    digits.textContent = remaining;
    if (remaining <= 10) {
      fg.classList.add('urgent');
      digits.style.color = 'var(--red)';
    } else {
      fg.classList.remove('urgent');
      digits.style.color = '';
    }
  }

  // Update judge screen timer (decision timer)
  const jfg = document.getElementById('judge-timer-fg');
  const jdigits = document.getElementById('judge-timer-digits');
  if (jfg && jdigits) {
    jfg.style.strokeDasharray = CIRC;
    jfg.style.strokeDashoffset = CIRC * pct;
    jdigits.textContent = remaining;
    if (remaining <= 5) {
      jfg.classList.add('urgent');
      jdigits.style.color = 'var(--red)';
    } else {
      jfg.classList.remove('urgent');
      jdigits.style.color = '';
    }
  }

  // Urgent screen border
  if (urgBorder) {
    if (remaining <= 10 && remaining > 0) urgBorder.classList.add('active');
    else urgBorder.classList.remove('active');
  }
}

// ======================== JUDGE PICK ========================
function renderJudgeScreen(stage) {
  const isLoc = stage === 'location';
  const isSuspect = stage === 'suspect';

  // Badge
  const badgeEl = document.getElementById('judge-badge');
  if (isLoc) badgeEl.innerHTML = '<div class="stage-badge loc">' + t('s1Loc') + '</div>';
  else if (isSuspect) badgeEl.innerHTML = '<div class="stage-badge sus">' + t('s3Sus') + '</div>';
  else badgeEl.innerHTML = '<div class="stage-badge weap">' + t('s2Weap') + '</div>';

  const isJudge = G.myRole === 'Judge';

  // Role info: show during word stages, hide during suspect stage
  if (isSuspect) {
    document.getElementById('judge-role-info').innerHTML = '';
  } else {
    document.getElementById('judge-role-info').innerHTML = isJudge ? '' : getRoleInfoHTML(isLoc ? 'location' : 'weapon');
  }

  if (isJudge) {
    document.getElementById('judge-title').textContent = isSuspect ? t('idSuspect') : (isLoc ? t('pickLoc') : t('pickWeap'));
    document.getElementById('judge-sub').textContent = t('makeChoice');
  } else {
    document.getElementById('judge-title').textContent = isSuspect ? t('susId') : (isLoc ? t('locPick') : t('weapPick'));
    document.getElementById('judge-sub').textContent = isSuspect ? t('judgeChoosing') : '';
  }

  // Grid / player list
  const gridEl = document.getElementById('judge-grid');
  const playersEl = document.getElementById('judge-players');
  const confirmBtn = document.getElementById('btn-judge-confirm');
  const waitEl = document.getElementById('judge-waiting');

  if (isSuspect) {
    gridEl.style.display = 'none';
    gridEl.innerHTML = '';
    playersEl.style.display = 'flex';
    const allPlayers = G.players;
    if (isJudge) {
      playersEl.innerHTML = allPlayers.filter(p => p !== NET.myName).map(p =>
        `<div class="player-chip interactive" onclick="selectJudgePick(this,'${esc(p)}')">${esc(p)}</div>`
      ).join('');
    } else {
      playersEl.innerHTML = allPlayers.map(p =>
        `<div class="player-chip">${esc(p)}</div>`
      ).join('');
    }
  } else {
    playersEl.style.display = 'none';
    playersEl.innerHTML = '';
    gridEl.style.display = 'grid';
    gridEl.style.gridTemplateColumns = `repeat(${G.gridCols}, 1fr)`;
    const grid = isLoc ? G.locationGrid : G.weaponGrid;
    if (isJudge) {
      gridEl.innerHTML = grid.map(item =>
        renderGridCell(item, true, `selectJudgePick(this,'${esc(item.word)}')`)
      ).join('');
    } else {
      gridEl.innerHTML = grid.map(item => renderGridCell(item, false)).join('');
    }
  }

  if (isJudge) {
    confirmBtn.style.display = 'block';
    confirmBtn.disabled = true;
    waitEl.style.display = 'none';
  } else {
    confirmBtn.style.display = 'none';
    waitEl.style.display = 'block';
  }

  // Initialize judge decision timer ring
  const jfg = document.getElementById('judge-timer-fg');
  const jdigits = document.getElementById('judge-timer-digits');
  jfg.style.strokeDasharray = CIRC;
  jfg.style.strokeDashoffset = 0;
  jfg.classList.remove('urgent');
  jdigits.textContent = G.timerTotal || 15;

  G.judgeSelection = null;
  showScreen('s-judge');
}

function selectJudgePick(el, value) {
  // Handle clicks on child elements (icon, label)
  const cell = el.closest ? el.closest('.word-cell, .player-chip') || el : el;
  const container = cell.closest('.word-grid, .player-list') || cell.parentElement;
  container.querySelectorAll('.selected').forEach(c => c.classList.remove('selected'));
  cell.classList.add('selected');
  G.judgeSelection = value;
  document.getElementById('btn-judge-confirm').disabled = false;
}

function judgeConfirmPick() {
  if (!G.judgeSelection) return;
  const stage = G.phase.replace('_judge', '');
  sendToHost({ type: 'judge-pick', stage, value: G.judgeSelection });
  document.getElementById('btn-judge-confirm').disabled = true;
}

// ======================== STAGE RESULT ========================
function showStageResult(data) {
  const isLoc = data.stage === 'location';
  const icon = data.correct ? '&#9989;' : '&#10060;';
  const cls = data.correct ? 'correct' : 'wrong';
  const msg = data.correct ? t('correct') : t('wrong');

  // Build icon card for guessed word
  const guessedArt = getCardArt(data.guessed);
  const guessedCard = `<div style="width:100px;height:100px;border-radius:12px;margin:8px auto;border:2px solid ${data.correct ? 'var(--green)' : 'var(--red)'};display:flex;flex-direction:column;align-items:center;justify-content:center;background:linear-gradient(135deg,${guessedArt[1]},${guessedArt[1]}ee);position:relative;overflow:hidden">
    <div style="position:absolute;inset:0;border-radius:10px;opacity:0.12;background:radial-gradient(circle at 50% 40%,${guessedArt[2]},transparent)"></div>
    <div style="font-size:36px;filter:drop-shadow(0 2px 4px rgba(0,0,0,0.3))">${guessedArt[0]}</div>
    <div style="font-size:10px;font-weight:700;color:var(--text);text-transform:uppercase;letter-spacing:0.5px">${esc(data.guessed)}</div>
  </div>`;

  const content = document.getElementById('result-content');
  content.innerHTML = `
    <div class="stage-badge ${isLoc ? 'loc' : 'weap'}">${isLoc ? '&#128205;' : '&#128298;'} ${isLoc ? t('loc') : t('weap')}</div>
    <div class="gap2"></div>
    <div style="font-size:56px">${icon}</div>
    <div class="gap"></div>
    <div class="result-banner ${cls}">${msg}</div>
    ${guessedCard}
    <p style="color:var(--text2);font-size:15px">${t('judgePicked')} <b style="color:var(--text)">${esc(tWord(data.guessed))}</b></p>
    ${!data.correct ? `<p style="color:var(--text3);font-size:14px;margin-top:4px">${t('correctAns')} <b>${esc(tWord(data.actual))}</b></p>` : ''}
  `;

  // Judge gets the continue button (re-enable it each time)
  const nextBtn = document.getElementById('btn-next-stage');
  nextBtn.disabled = false;
  const waitEl = document.getElementById('result-wait');
  if (G.myRole === 'Judge') {
    nextBtn.style.display = 'block';
    waitEl.style.display = 'none';
  } else {
    nextBtn.style.display = 'none';
    waitEl.style.display = 'block';
  }

  showScreen('s-result');
}

function requestNextStage() {
  sendToHost({ type: 'next-stage' });
  document.getElementById('btn-next-stage').disabled = true;
}

// ======================== SUSPECT GUESS ========================
function renderSuspectScreen() {
  const isSuspect = G.myRole === 'Suspect';
  const contentEl = document.getElementById('suspect-content');
  const confirmBtn = document.getElementById('btn-suspect-confirm');
  const waitEl = document.getElementById('suspect-wait');

  if (isSuspect) {
    contentEl.innerHTML = `
      <h2>${t('whoWitness')}</h2>
      <h3>${t('pickWitness')}</h3>
      <div class="gap"></div>
      <div class="player-list" id="suspect-player-list">
        ${G.players.filter(p => p !== NET.myName).map(p =>
          `<div class="player-chip interactive" onclick="selectSuspectTarget(this,'${esc(p)}')">${esc(p)}</div>`
        ).join('')}
      </div>
    `;
    confirmBtn.style.display = 'block';
    confirmBtn.disabled = true;
    confirmBtn.textContent = t('confirmGuess');
    waitEl.style.display = 'none';
  } else {
    contentEl.innerHTML = `
      <h2>${t('susId')}</h2>
      <h3>${t('susGuessing')}</h3>
    `;
    confirmBtn.style.display = 'none';
    waitEl.style.display = 'block';
  }

  G.suspectVote = null;
  showScreen('s-suspect');
}

function selectSuspectTarget(el, name) {
  document.querySelectorAll('#suspect-player-list .player-chip').forEach(c => c.classList.remove('selected'));
  el.classList.add('selected');
  G.suspectVote = name;
  document.getElementById('btn-suspect-confirm').disabled = false;
}

function suspectConfirmVote() {
  if (!G.suspectVote) return;
  sendToHost({ type: 'suspect-vote', name: NET.myName, target: G.suspectVote });
  document.getElementById('btn-suspect-confirm').disabled = true;
  document.getElementById('btn-suspect-confirm').textContent = t('voteSubmitted');
}

// ======================== GAME OVER ========================
function showGameOver(data) {
  document.getElementById('urgent-border').classList.remove('active');
  const content = document.getElementById('gameover-content');

  if (data.teamWins) {
    content.innerHTML = `
      <div style="font-size:64px">&#127942;</div>
      <div class="gap"></div>
      <h1 style="color:var(--green)">${t('teamWins')}</h1>
      <p class="subtitle" style="margin-top:8px">${t('teamWinsD')}</p>
    `;
  } else {
    let reason = '';
    if (data.timedOut) reason += t('judgeTO');
    if (data.locCorrect === false) reason += t('wrongLoc');
    if (data.weapCorrect === false) reason += t('wrongWeap');
    if (data.witnessExposed) reason += t('witExposed');
    content.innerHTML = `
      <div style="font-size:64px">${data.timedOut ? '&#9203;' : '&#128308;'}</div>
      <div class="gap"></div>
      <h1 style="color:var(--red)">${t('susWin')}</h1>
      <p class="subtitle" style="margin-top:8px">${reason.trim()}</p>
    `;
  }

  // Results summary
  const suspectVoteNames = Object.entries(data.suspectVotes || {}).map(([s, v]) => `${esc(s)}${t('guessed')}${esc(v)}`).join(', ');
  const summaryHTML = `
    <div class="card" style="text-align:left;margin-top:8px">
      <p style="font-size:13px;color:var(--text2);margin-bottom:8px"><b>${t('resultsLabel')}</b></p>
      <p style="font-size:14px;margin-bottom:4px">${data.locCorrect === null ? '&#8212;' : (data.locCorrect ? '&#9989;' : '&#10060;')} ${t('loc')}: ${data.locCorrect === null ? '<b>' + t('notReached') + '</b>' : '<b>' + esc(tWord(data.judgeGuesses.location) || '?') + '</b>' + (data.locCorrect === false ? ' (was ' + esc(tWord(data.correctLocation)) + ')' : '')}</p>
      <p style="font-size:14px;margin-bottom:4px">${data.weapCorrect === null ? '&#8212;' : (data.weapCorrect ? '&#9989;' : '&#10060;')} ${t('weap')}: ${data.weapCorrect === null ? '<b>' + t('notReached') + '</b>' : '<b>' + esc(tWord(data.judgeGuesses.weapon) || '?') + '</b>' + (data.weapCorrect === false ? ' (was ' + esc(tWord(data.correctWeapon)) + ')' : '')}</p>
      <p style="font-size:14px;margin-bottom:4px">${data.judgeGuesses.suspect ? (data.roles[data.judgeGuesses.suspect] === 'Suspect' ? '&#9989;' : '&#10060;') : '&#8212;'} ${t('susGuessLabel')} ${data.judgeGuesses.suspect ? '<b>' + esc(data.judgeGuesses.suspect) + '</b>' : '<b>' + t('notReached') + '</b>'}</p>
      <p style="font-size:14px">${data.witnessExposed === undefined ? '&#8212; ' + t('witExpLabel') + ' <b>' + t('notReached') + '</b>' : (data.witnessExposed ? '&#10060; ' + t('witExpLabel') + ' <b>' + t('yesW') + '</b>' : '&#9989; ' + t('witExpLabel') + ' <b>' + t('noW') + '</b>')}</p>
      ${suspectVoteNames ? `<p style="font-size:13px;color:var(--text3);margin-top:4px">${suspectVoteNames}</p>` : ''}
    </div>
  `;

  // Role reveal
  const rolesHTML = G.players.map(p => {
    const role = data.roles[p];
    const cls = role ? role.toLowerCase() : '';
    return `<div class="reveal-role"><span class="rname">${esc(p)}</span><span class="rtag ${cls}">${role ? tRole(role) : '?'}</span></div>`;
  }).join('');

  document.getElementById('gameover-roles').innerHTML = summaryHTML + '<div class="gap"></div>' + rolesHTML;

  // Play again button for host only
  document.getElementById('btn-play-again').style.display = NET.isHost ? 'block' : 'none';

  showScreen('s-gameover');
}

function playAgain() {
  sendToHost({ type: 'play-again' });
}

// ======================== ATMOSPHERE: PARTICLES ========================
function spawnParticles() {
  const container = document.getElementById('atmosphere');
  if (!container) return;
  function create() {
    const p = document.createElement('div');
    p.className = 'particle';
    const size = 1 + Math.random() * 2.5;
    p.style.width = size + 'px';
    p.style.height = size + 'px';
    p.style.left = Math.random() * 100 + 'vw';
    p.style.bottom = '-10px';
    const dur = 10 + Math.random() * 15;
    p.style.animation = 'floatUp ' + dur + 's linear forwards';
    container.appendChild(p);
    setTimeout(() => p.remove(), dur * 1000);
  }
  for (let i = 0; i < 6; i++) setTimeout(create, i * 500);
  setInterval(() => { if (document.visibilityState !== 'hidden') create(); }, 2500 + Math.random() * 2000);
}

// ======================== INIT ========================
function init() {
  if (isLocalServer()) {
    LOCAL.active = true;
    LOCAL.baseUrl = location.origin;
    document.getElementById('local-badge').style.display = 'block';
  }
  setLang(currentLang);
  const params = new URLSearchParams(window.location.search);
  const joinCode = params.get('join') || params.get('room');
  if (joinCode) {
    document.getElementById('join-code-input').value = joinCode.toUpperCase();
    showScreen('s-join');
  }
  spawnParticles();
}

init();
</script>
</body>
</html>
